<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Магазины App</title>
  <style>
    :root{--bg:#fff;--text:#111;--muted:#667085;--surface:#f4f6f8;--border:#e3e8ef;--accent:#3b82f6;--accent-contrast:#fff;--shadow:0 10px 20px rgba(0,0,0,.06);--header-h:0px;--green:#22c55e;--purple:#a855f7}
    [data-theme="dark"]{--bg:#0b0f14;--text:#e6e9ef;--muted:#a8b0bb;--surface:#121821;--border:#1e2632;--accent:#60a5fa;--accent-contrast:#0b0f14;--shadow:0 10px 22px rgba(0,0,0,.35)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    .header{position:sticky;top:0;z-index:900;background:var(--bg);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
    .header-inner{max-width:1200px;margin:0 auto;padding:10px 16px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px}
    .theme-area{display:flex;align-items:center;gap:10px;justify-self:start}
    .switch{--w:50px;--h:28px;--r:14px;position:relative;width:var(--w);height:var(--h)}
    .switch input{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2}
    .track{position:absolute;inset:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);transition:.2s}
    .thumb{position:absolute;top:50%;left:4px;width:20px;height:20px;transform:translateY(-50%);border-radius:50%;background:var(--accent);transition:.2s}
    .switch input:checked+.track .thumb{left:calc(100% - 24px)}
    .theme-label{font-size:14px;color:var(--muted);min-width:84px;user-select:none}
    nav[role="tablist"]{justify-self:center;display:flex;align-items:center;gap:4px}
    .tabs{list-style:none;padding:0;margin:0;display:flex;align-items:center;gap:6px}
    .tab-btn{appearance:none;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:14px;padding:8px 14px;border-radius:999px;cursor:pointer;transition:background .15s,border-color .15s,transform .05s;white-space:nowrap}
    .tab-btn[aria-selected="true"]{background:var(--accent);color:var(--accent-contrast);border-color:var(--accent)}
    .tab-btn:active{transform:translateY(1px)}
    .tab-btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .container{width:100%;margin:24px 0;padding:0 0 40px}
    .panel{border:1px solid var(--border);background:var(--surface);border-radius:16px;padding:18px;box-shadow:var(--shadow);display:none;overflow:visible}
    .panel.active{display:block}
    /* ——— Фильтры и инпуты ——— */
    .filter{display:flex;flex-direction:column;gap:6px}
    .filter label{font-size:12px;color:var(--muted)}
    .filter select,.filter input[type=text],.filter input[type=date],.filter input[type=tel],.filter input[type=number]{background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px;outline:none}
    .filter select:focus,.filter input[type=text]:focus,.filter input[type=date]:focus,.filter input[type=tel]:focus,.filter input[type=number]:focus{border-color:var(--accent)}
    .btn{border:1px solid var(--border);background:var(--surface);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;transition:background .15s,border-color .15s,transform .05s}
    .btn:hover{border-color:var(--accent)} .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:var(--accent-contrast)}
    .btn-small{padding:6px 10px;font-size:13px;border-radius:999px}
    .btn-green{background:var(--green);border-color:var(--green);color:#fff}
    .btn-purple{background:var(--purple);border-color:var(--purple);color:#fff}
    .muted{color:var(--muted)} .money{font-variant-numeric:tabular-nums}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle;filter:saturate(1.4) brightness(1.12);box-shadow:0 0 0 1px rgba(0,0,0,.28)}
    .chip{display:inline-block;padding:2px 6px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-left:6px;opacity:.8}
    /* ——— Наличие / Предзаказ шапки ——— */
    .nalichie-head,.preorder-head{position:sticky;top:var(--header-h);background:var(--bg);padding:12px 16px;border-bottom:1px solid var(--border);display:grid;gap:10px;z-index:1100;overflow:visible;border-radius:12px 12px 0 0}
    .nalichie-head{grid-template-columns:repeat(6,minmax(140px,1fr))}
    .preorder-head{grid-template-columns:repeat(6,minmax(140px,1fr))}
    .nalichie-head .filter,.nalichie-head select{position:relative;z-index:1200}
    .nalichie-actions,.preorder-actions{grid-column:-2/-1;justify-self:end;display:flex;gap:8px;align-self:end}
    .nalichie-body{padding:0 16px 16px;overflow:visible}
    /* ——— Таблицы ——— */
    .table{width:100%;border-collapse:collapse;border:1px solid var(--border);background:var(--surface);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .table thead th{text-align:left;font-weight:600;font-size:13px;color:var(--muted);padding:10px 12px;border-bottom:1px solid var(--border);background:var(--surface)}
    .table tbody td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
    .table tbody tr:hover{background:rgba(0,0,0,.03)} [data-theme="dark"] .table tbody tr:hover{background:rgba(255,255,255,.04)}
    .shift-date-row td{background:var(--surface);font-weight:600;padding:12px 16px;border-bottom:1px solid var(--border);color:var(--muted)}
    .shift-subtotal td{background:rgba(59,130,246,.08);font-weight:600;padding:10px 12px;border-bottom:1px solid var(--border)}
    /* ——— Модалки ——— */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:2000}
    .modal{position:fixed;left:50%;transform:translateX(-50%);top:4vh;width:min(860px,96vw);max-height:92vh;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;display:none;z-index:2100;overflow:hidden}
    .modal.open{display:flex;flex-direction:column} .modal-backdrop.open{display:block}
    .modal-header,.modal-footer{display:flex;justify-content:space-between;align-items:center;background:var(--bg)}
    .modal-header{margin-bottom:8px} .modal-title{font-size:18px;font-weight:700}
    .modal-body{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:10px;flex:1 1 auto;overflow:auto;min-height:0}
    .modal-row{display:flex;flex-direction:column;gap:6px}
    .modal-row label{font-size:12px;color:var(--muted)}
    .modal-row input,.modal-row select,.modal-row textarea{background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px;outline:none}
    .modal-row textarea{min-height:72px;resize:vertical}
    .modal-footer{justify-content:flex-end;gap:8px;margin-top:12px}
    .sep{grid-column:1/-1;height:1px;background:var(--border);margin:4px 0}
    /* ——— Смены ——— */
    .shifts-head{display:grid;grid-template-columns:repeat(6,minmax(160px,1fr)) auto;gap:10px;margin-bottom:12px}
    .shifts-toolbar{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr)) auto;gap:10px;margin:12px 0}
    #btnLedgerUpdate{justify-self:end;min-width:220px}
    .shift-days{display:flex;flex-direction:column;gap:20px;margin-top:12px}
    .shift-day{border:1px solid var(--border);background:var(--surface);border-radius:16px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
    .shift-day-header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .shift-day-header-main{display:flex;flex-direction:column;gap:4px}
    .shift-day-date{font-size:18px;font-weight:700}
    .shift-day-weekday{font-size:14px;color:var(--muted)}
    .shift-day-header-meta{display:flex;flex-wrap:wrap;gap:10px;font-size:14px;color:var(--muted)}
    .shift-day-meta-item{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:var(--bg);color:var(--muted)}
    .shift-day-meta-item strong{color:var(--text)}
    .shift-day-body{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .shift-card{border:1px solid var(--border);border-radius:12px;background:var(--bg);box-shadow:var(--shadow);padding:10px;display:flex;flex-direction:column;gap:8px;min-height:0}
    .shift-card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .shift-card-title{display:flex;flex-direction:column;gap:4px;min-width:0}
    .shift-card-store{font-weight:600;font-size:15px;word-break:break-word}
    .shift-card-staff{font-size:14px;color:var(--muted);display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .shift-card-time{text-align:right;font-size:13px;color:var(--muted)}
    .shift-card-time-label{display:block;font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    .shift-card-time-value{font-size:15px;font-weight:600;color:var(--text)}
    .shift-card-body{display:flex;flex-direction:column;gap:8px}
    .shift-card-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
    .shift-metric{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:var(--surface);display:flex;flex-direction:column;gap:4px;min-height:0}
    .shift-metric-label{font-size:12px;letter-spacing:.04em;text-transform:uppercase;color:var(--muted)}
    .shift-metric-value{font-size:15px;font-weight:600;white-space:nowrap}
    .shift-metric-accent{background:var(--accent);border-color:var(--accent);color:var(--accent-contrast)}
    .shift-metric-accent .shift-metric-label{color:inherit;opacity:.85}
    .shift-metric-accent .shift-metric-value{color:inherit}
    .shift-positions{display:flex;flex-wrap:wrap;gap:8px}
    .shift-position{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-size:13px}
    .shift-position-icon{font-size:16px;line-height:1}
    .shift-position-label{font-size:12px;color:var(--muted)}
    .shift-position-value{font-weight:600;color:var(--text)}
    .shift-position-empty{opacity:.55}
    .shift-card-footer{display:flex;flex-wrap:wrap;gap:8px;padding-top:6px;border-top:1px solid var(--border)}
    .shift-card-footer .shift-metric{flex:1 1 160px;min-height:0}
    .shift-day-footer{border-top:1px solid var(--border);padding-top:10px;display:flex;flex-direction:column;gap:8px}
    .shift-day-footer-title{font-weight:600;font-size:14px}
    .shift-day-footer-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .shift-day-footer-positions{display:flex;flex-direction:column;gap:8px}
    .shift-day-empty{padding:24px;border:1px dashed var(--border);border-radius:12px;text-align:center;color:var(--muted)}
    .shift-grand-total{margin-top:16px;padding:12px;border:1px solid var(--border);border-radius:16px;background:var(--surface);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px}
    .shift-grand-total-title{font-size:18px;font-weight:700}
    .shift-grand-total-body{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .shift-grand-total-positions{display:flex;flex-direction:column;gap:8px}
    /* ——— Адаптив ——— */
    @media (max-width:1100px){.nalichie-head,.preorder-head{grid-template-columns:repeat(3,minmax(140px,1fr))}}
    @media (max-width:720px){
      .header-inner{grid-template-columns:1fr;gap:10px}
      nav[role="tablist"]{justify-self:start;overflow-x:auto;max-width:100%}
      .tabs{gap:8px}
      .nalichie-head,.preorder-head{position:static;grid-template-columns:1fr 1fr}
      .nalichie-actions,.preorder-actions{grid-column:1/-1;justify-self:start}
      .modal{top:2%;width:96vw;max-height:96vh}
      .modal-body{grid-template-columns:1fr}
      .shifts-head{grid-template-columns:1fr 1fr}
      .shifts-toolbar{grid-template-columns:1fr 1fr}
      #btnLedgerUpdate{justify-self:stretch}
      .table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
      .table thead,.table tbody,.table tfoot{width:max-content;min-width:100%}
      .shift-day{padding:10px}
      .shift-day-header{flex-direction:column;align-items:flex-start}
      .shift-day-header-meta{width:100%}
      .shift-day-meta-item{width:100%;justify-content:space-between}
      .shift-day-body{grid-template-columns:minmax(0,1fr)}
      .shift-card{padding:8px;gap:8px}
      .shift-card-header{flex-direction:column;align-items:flex-start}
      .shift-card-time{text-align:left}
      .shift-card-metrics{grid-template-columns:minmax(0,1fr)}
      .shift-card-footer .shift-metric{flex:1 1 100%}
      .shift-day-footer-metrics,.shift-grand-total-body{grid-template-columns:minmax(0,1fr)}
    }
    @media (max-height:820px){
      .header-inner{padding:6px 12px}
      .tab-btn{padding:6px 10px;font-size:13px}
      .nalichie-head,.preorder-head{padding:8px 12px;gap:8px}
      .filter select,.filter input{padding:6px 8px;font-size:13px}
      .table thead th{padding:8px 10px;font-size:12px}
      .table tbody td{padding:8px 10px;font-size:13px}
      .modal{top:2vh;max-height:96vh}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="theme-area">
        <div class="switch" title="Переключить тему">
          <input id="themeToggle" type="checkbox" aria-label="Переключить тему">
          <div class="track"><div class="thumb"></div></div>
        </div>
        <span id="themeText" class="theme-label">Светлая тема</span>
      </div>
      <nav role="tablist" aria-label="Основное меню">
        <ul class="tabs">
          <li><button class="tab-btn" role="tab" aria-controls="tab-nalichie" aria-selected="true" data-tab="nalichie">Наличие</button></li>
          <li><button class="tab-btn" role="tab" aria-controls="tab-daily" aria-selected="false" data-tab="daily">Ежедневный отчет</button></li>
          <li><button class="tab-btn" role="tab" aria-controls="tab-preorder" aria-selected="false" data-tab="preorder">Предзаказ</button></li>
          <li><button class="tab-btn" role="tab" aria-controls="tab-diagnostics" aria-selected="false" data-tab="diagnostics">Диагностика</button></li>
          <li><button class="tab-btn" role="tab" aria-controls="tab-shifts" aria-selected="false" data-tab="shifts">Смены</button></li>
          <li><button class="tab-btn" role="tab" aria-controls="tab-admin" aria-selected="false" data-tab="admin">Админ</button></li>
        </ul>
      </nav>
      <div></div>
    </div>
  </header>

  <main class="container">
    <!-- НАЛИЧИЕ -->
    <section id="tab-nalichie" class="panel active" role="tabpanel">
      <div class="nalichie-head" id="nalichieHead">
        <div class="filter"><label for="fltCity">Город</label><select id="fltCity"></select></div>
        <div class="filter"><label for="fltCondition">Состояние</label><select id="fltCondition"></select></div>
        <div class="filter"><label for="fltModel">Модель</label><select id="fltModel"></select></div>
        <div class="filter"><label for="fltMemory">Память</label><select id="fltMemory"></select></div>
        <div class="filter"><label for="fltColor">Цвет</label><select id="fltColor"></select></div>
        <div class="filter"><label for="searchImei">Поиск по IMEI</label><input id="searchImei" type="text" placeholder="Введите IMEI..."/></div>
        <div class="nalichie-actions">
          <button id="btnSellAccessory" class="btn btn-green">Продать аксессуар</button>
          <button id="btnSellService" class="btn btn-purple">Продать услугу</button>
        </div>
      </div>
      <div class="nalichie-body">
        <table class="table" id="stockTable" aria-label="Позиции склада">
          <thead><tr id="stockHeadRow"></tr></thead>
          <tbody id="stockTbody"></tbody>
        </table>
        <p id="stockCount" class="muted" style="margin-top:10px;"></p>
      </div>
    </section>

    <!-- ЕЖЕДНЕВНЫЙ -->
    <section id="tab-daily" class="panel" role="tabpanel">
      <h2>Ежедневный отчет</h2>
      <p class="placeholder">Сюда добавим дашборд/сводку за день.</p>
    </section>

    <!-- ПРЕДЗАКАЗ -->
    <section id="tab-preorder" class="panel" role="tabpanel">
      <h2 style="margin-top:0;">Предзаказ</h2>
      <div class="preorder-head">
        <div class="filter"><label>С даты</label><input type="date" id="preFrom"></div>
        <div class="filter"><label>По дату</label><input type="date" id="preTo"></div>
        <div class="filter"><label>Магазин</label><select id="preStore"></select></div>
        <div class="filter"><label>Сотрудник</label><select id="preStaff"></select></div>
        <div class="filter"><label>Статус</label><select id="preStatus"></select></div>
        <div class="filter"><label>Модель</label><select id="preModel"></select></div>
        <div class="filter"><label>Память</label><select id="preMemory"></select></div>
        <div class="filter"><label>Цвет</label><select id="preColor"></select></div>
        <div class="filter"><label>Клиент</label><input type="text" id="preCustomer" placeholder="Имя / часть"></div>
        <div class="filter"><label>Телефон</label><input type="tel" id="prePhone" placeholder="Номер / часть"></div>
        <div class="preorder-actions">
          <button id="btnPreRefresh" class="btn">Обновить</button>
          <button id="btnPreNew" class="btn btn-primary">Новый предзаказ</button>
        </div>
      </div>
      <div style="padding:0 16px 16px;">
        <table class="table" id="preTable" aria-label="Учёт предзаказов">
          <thead>
            <tr>
              <th>Дата</th><th>Магазин</th><th>Сотрудник</th><th>Модель</th><th>Память</th><th>Цвет</th>
              <th>IMEI (pre_imei)</th><th class="money">Сумма ₽</th><th class="money">Внесено ₽</th>
              <th class="money">Остаток ₽</th><th>Оплаты</th><th>Клиент</th><th>Телефон</th>
              <th class="money">ЗП ₽</th><th>Примечание</th><th>Статус</th>
            </tr>
          </thead>
          <tbody id="preTbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="7" style="font-weight:600;">Итого:</td>
              <td class="money" id="preSumPrice">—</td>
              <td class="money" id="preSumPrepay">—</td>
              <td></td><td colspan="3"></td>
              <td class="money" id="preSumZp">—</td><td></td><td></td>
            </tr>
          </tfoot>
        </table>
        <p id="preCount" class="muted" style="margin-top:10px;"></p>
      </div>
    </section>

    <!-- ДИАГНОСТИКА -->
    <section id="tab-diagnostics" class="panel" role="tabpanel">
      <h2 style="margin-top:0;">Диагностика</h2>
      <div class="preorder-head" id="diagHead">
        <div class="filter"><label>С даты</label><input type="date" id="diagFrom"></div>
        <div class="filter"><label>По дату</label><input type="date" id="diagTo"></div>
        <div class="filter"><label>Магазин</label><select id="diagStore"></select></div>
        <div class="filter"><label>Сотрудник</label><select id="diagStaff"></select></div>
        <div class="filter"><label>Статус</label><select id="diagStatus"></select></div>
        <div class="filter"><label>Модель</label><select id="diagModel"></select></div>
        <div class="filter"><label>Память</label><select id="diagMemory"></select></div>
        <div class="filter"><label>Цвет</label><select id="diagColor"></select></div>
        <div class="filter"><label>Клиент</label><input type="text" id="diagCustomer" placeholder="Имя / часть"></div>
        <div class="filter"><label>Телефон</label><input type="tel" id="diagPhone" placeholder="Номер / часть"></div>
        <div class="filter"><label>IMEI</label><input type="text" id="diagImei" placeholder="IMEI / часть"></div>
        <div class="filter"><label>Дата покупки</label><input type="date" id="diagPurchaseDate"></div>
        <div class="preorder-actions">
          <button id="btnDiagRefresh" class="btn">Обновить</button>
          <button id="btnDiagNew" class="btn btn-primary">Новая диагностика</button>
        </div>
      </div>
      <div style="padding:0 16px 16px;">
        <table class="table" id="diagTable" aria-label="Учёт диагностики">
          <thead>
            <tr>
              <th>Дата приёма</th><th>Магазин</th><th>Сотрудник</th><th>Модель</th><th>Память</th><th>Цвет</th>
              <th>IMEI</th><th>Дата покупки</th><th class="money">Оплачено ₽</th>
              <th>Оплаты</th><th>Клиент</th><th>Телефон</th><th>Комплект</th><th>Внешний вид</th><th>Неисправность</th><th>Примечание</th><th>Статус</th>
            </tr>
          </thead>
          <tbody id="diagTbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="8" style="font-weight:600;">Итого:</td>
              <td class="money" id="diagSumPaid">—</td>
              <td colspan="7"></td>
            </tr>
          </tfoot>
        </table>
        <p id="diagCount" class="muted" style="margin-top:10px;"></p>
      </div>
    </section>

    <!-- СМЕНЫ -->
    <section id="tab-shifts" class="panel" role="tabpanel">
      <h2 style="margin-top:0;">Смены</h2>
      <div class="shifts-head">
        <div class="filter"><label for="shiftStore">Магазин</label><select id="shiftStore"></select></div>
        <div class="filter"><label for="shiftStaff">Сотрудник</label><select id="shiftStaff"></select></div>
        <div class="filter"><label for="shiftDateAuto">Дата (авто)</label><input id="shiftDateAuto" type="text" readonly/></div>
        <div class="filter"><label for="shiftTimeAuto">Время (авто)</label><input id="shiftTimeAuto" type="text" readonly/></div>
        <div class="filter"><label>&nbsp;</label><button id="btnShiftCheckIn" class="btn btn-primary">Отметиться</button></div>
        <div class="last-check" id="lastCheckLabel"></div>
      </div>
      <div class="shifts-toolbar">
        <div class="filter"><label for="ledgerFrom">С даты</label><input id="ledgerFrom" type="date"></div>
        <div class="filter"><label for="ledgerTo">По дату</label><input id="ledgerTo" type="date"></div>
        <div class="filter"><label for="ledgerStore">Магазин</label><select id="ledgerStore"></select></div>
        <div class="filter"><label for="ledgerStaff">Сотрудник</label><select id="ledgerStaff"></select></div>
        <button id="btnLedgerUpdate" class="btn btn-primary">Обновить</button>
      </div>
      <div id="shiftDays" class="shift-days" aria-live="polite"></div>
      <div id="shiftGrandTotal" class="shift-grand-total" aria-live="polite"></div>
    </section>

    <section id="tab-admin" class="panel" role="tabpanel">
      <?!= include('AdminUI') ?>
    </section>
  </main>

  <!-- BACKDROP -->
  <div id="modalBackdrop" class="modal-backdrop"></div>

  <!-- ======== Продажа телефона ======== -->
  <div id="saleModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="saleTitle">
    <div class="modal-header"><div class="modal-title" id="saleTitle">Продажа</div><button id="btnCloseSale" class="btn">Закрыть</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>ID</label><input id="saleId" type="text" readonly placeholder="сгенерируется при сохранении"></div>
      <div class="modal-row"><label>Дата</label><input id="saleDate" type="date"></div>
      <div class="modal-row"><label>Магазин</label><select id="saleStore"></select></div>
      <div class="modal-row"><label>Сотрудник</label><select id="saleStaff"></select></div>
      <div class="modal-row"><label>Тип товара</label><input id="saleItemType" type="text" readonly></div>
      <div class="modal-row"><label>Состояние</label><select id="saleCondition"></select></div>
      <div class="modal-row"><label>Модель</label><input id="saleModel" type="text" readonly></div>
      <div class="modal-row"><label>Память</label><input id="saleMemory" type="text" readonly></div>
      <div class="modal-row"><label>Цвет</label><input id="saleColor" type="text" readonly></div>
      <div class="modal-row"><label>IMEI / SKU</label><input id="saleImeiSku" type="text" readonly></div>
      <div class="modal-row"><label>Итого (₽)</label><input id="saleTotal" type="number" step="0.01" class="money"></div>
      <div class="modal-row"><label>Сдача</label><input id="saleSdacha" type="text"></div>
      <div class="sep"></div>
      <div class="modal-row" style="grid-column:1/-1">
        <label>Оплаты</label>
        <div id="paymentsList" style="display:flex;flex-direction:column;gap:6px"></div>
        <button id="btnAddPayment" class="btn btn-small" type="button">Добавить оплату</button>
      </div>
      <div class="modal-row"><label>Клиент</label><input id="saleCustomer" type="text"></div>
      <div class="modal-row"><label>Телефон</label><input id="salePhone" type="text"></div>
      <div class="modal-row"><label>Зарплата</label><input id="saleZarplata" type="text"></div>
      <div class="modal-row" style="grid-column:1/-1"><label>Примечание</label><textarea id="saleNote"></textarea></div>
    </div>
    <div class="modal-footer"><button id="btnSaveSale" class="btn btn-primary">Сохранить</button></div>
  </div>

  <!-- ======== Продажа аксессуара ======== -->
  <div id="accessoryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="accTitle">
    <div class="modal-header"><div class="modal-title" id="accTitle">Продажа аксессуара</div><button class="btn" data-close="#accessoryModal">Закрыть</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>ID</label><input id="accId" type="text" readonly placeholder="сгенерируется при сохранении"></div>
      <div class="modal-row"><label>Дата</label><input id="accDate" type="date"></div>
      <div class="modal-row"><label>Магазин</label><select id="accStore"></select></div>
      <div class="modal-row"><label>Сотрудник</label><select id="accStaff"></select></div>
      <div class="modal-row"><label>Тип товара</label><input id="accItemType" type="text" readonly></div>
      <div class="modal-row" style="grid-column:1/-1"><label>Товар (из склада аксессуаров)</label><select id="accItemSelect"></select></div>
      <div class="modal-row"><label>Модель</label><input id="accModel" type="text" readonly></div>
      <div class="modal-row"><label>SKU</label><input id="accSku" type="text" readonly></div>
      <div class="modal-row"><label>Цена продажи (₽)</label><input id="accTotal" type="number" step="0.01" class="money"></div>
      <div class="modal-row"><label>Доступно на складе (шт)</label><input id="accQty" type="number" readonly></div>
      <div class="sep"></div>
      <div class="modal-row" style="grid-column:1/-1">
        <label>Оплаты</label>
        <div id="accPaymentsList" style="display:flex;flex-direction:column;gap:6px"></div>
        <button id="btnAccAddPayment" class="btn btn-small" type="button">Добавить оплату</button>
      </div>
      <div class="modal-row"><label>Сдача</label><input id="accSdacha" type="text"></div>
      <div class="modal-row"><label>Зарплата</label><input id="accZp" type="text"></div>
    </div>
    <div class="modal-footer"><button id="btnSaveAccessory" class="btn btn-green">Сохранить</button></div>
  </div>

  <!-- ======== Продажа услуги ======== -->
  <div id="serviceModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="svcTitle">
    <div class="modal-header"><div class="modal-title" id="svcTitle">Продажа услуги</div><button class="btn" data-close="#serviceModal">Закрыть</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>ID</label><input id="svcId" type="text" readonly placeholder="сгенерируется при сохранении"></div>
      <div class="modal-row"><label>Дата</label><input id="svcDate" type="date"></div>
      <div class="modal-row"><label>Магазин</label><select id="svcStore"></select></div>
      <div class="modal-row"><label>Сотрудник</label><select id="svcStaff"></select></div>
      <div class="modal-row"><label>Тип товара</label><input id="svcItemType" type="text" readonly></div>
      <div class="modal-row" style="grid-column:1/-1"><label>Название услуги</label><input id="svcModel" type="text" placeholder="Например: Замена стекла"></div>
      <div class="sep"></div>
      <div class="modal-row" style="grid-column:1/-1">
        <label>Оплаты</label>
        <div id="svcPaymentsList" style="display:flex;flex-direction:column;gap:6px"></div>
        <button id="btnSvcAddPayment" class="btn btn-small" type="button">Добавить оплату</button>
      </div>
      <div class="modal-row"><label>Итого (автосумма, ₽)</label><input id="svcTotal" type="number" step="0.01" class="money" readonly></div>
      <div class="modal-row"><label>Сдача</label><input id="svcSdacha" type="text"></div>
      <div class="modal-row"><label>Зарплата</label><input id="svcZp" type="text"></div>
    </div>
    <div class="modal-footer"><button id="btnSaveService" class="btn btn-purple">Сохранить</button></div>
  </div>

  <!-- ======== Новый предзаказ ======== -->
  <div id="preNewModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="preNewTitle">
    <div class="modal-header"><div class="modal-title" id="preNewTitle">Новый предзаказ</div><button class="btn" data-close="#preNewModal">Закрыть</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>Дата</label><input id="preNewDate" type="date"></div>
      <div class="modal-row"><label>Магазин</label><select id="preNewStore"></select></div>
      <div class="modal-row"><label>Сотрудник</label><select id="preNewStaff"></select></div>
      <div class="modal-row"><label>Статус (авто «Ожидание»)</label><input id="preNewStatus" type="text" readonly></div>
      <div class="modal-row"><label>Модель</label><select id="preNewModel"></select></div>
      <div class="modal-row"><label>Память</label><select id="preNewMemory"></select></div>
      <div class="modal-row"><label>Цвет</label><select id="preNewColor"></select></div>
      <div class="modal-row"><label>Цена (₽)</label><input id="preNewPrice" type="number" step="0.01" class="money"></div>
      <div class="modal-row"><label>Предоплата (₽)</label><input id="preNewPrepay" type="number" step="0.01" class="money" readonly></div>
      <div class="modal-row"><label>Остаток к оплате (pre_balance, ₽)</label><input id="preNewBalance" type="number" step="0.01" class="money" readonly></div>
      <div class="sep"></div>
      <div class="modal-row" style="grid-column:1/-1">
        <label>Оплаты</label>
        <div id="preNewPaymentsList" style="display:flex;flex-direction:column;gap:6px"></div>
        <button id="btnPreNewAddPay" class="btn btn-small" type="button">Добавить оплату</button>
      </div>
      <div class="modal-row"><label>Клиент</label><input id="preNewCustomer" type="text"></div>
      <div class="modal-row"><label>Телефон</label><input id="preNewPhone" type="tel"></div>
      <div class="modal-row"><label>Зарплата</label><input id="preNewZp" type="text"></div>
      <div class="modal-row" style="grid-column:1/-1"><label>Примечание</label><textarea id="preNewNote"></textarea></div>
    </div>
    <div class="modal-footer"><button id="btnPreNewSave" class="btn btn-primary">Сохранить</button></div>
  </div>

  <!-- ======== Завершение предзаказа ======== -->
  <div id="preFinishModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="preFinishTitle">
    <div class="modal-header"><div class="modal-title" id="preFinishTitle">Завершение предзаказа</div><button class="btn" id="btnPreFinishClose" data-close="#preFinishModal">Отмена</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>ID</label><input id="preFinId" type="text" readonly></div>
      <div class="modal-row"><label>Дата завершения</label><input id="preFinDate" type="date"></div>
      <div class="modal-row"><label>Магазин</label><input id="preFinStore" type="text" readonly></div>
      <div class="modal-row"><label>Сотрудник (кто завершил)</label><select id="preFinStaff"></select></div>
      <div class="modal-row"><label>IMEI</label><input id="preFinImei" type="text" placeholder="Обязателен для завершения"></div>
      <div class="modal-row"><label>Цена (₽)</label><input id="preFinPrice" type="number" class="money" readonly></div>
      <div class="modal-row"><label>Уже внесено (₽)</label><input id="preFinPrepaid" type="number" class="money" readonly></div>
      <div class="modal-row"><label>Остаток до завершения (₽)</label><input id="preFinBalanceBase" type="number" class="money" readonly></div>
      <div class="sep"></div>
      <div class="modal-row" style="grid-column:1/-1">
        <label>Оплаты при завершении</label>
        <div id="preFinPaymentsList" style="display:flex;flex-direction:column;gap:6px"></div>
        <button id="btnPreFinAddPay" class="btn btn-small" type="button">Добавить оплату</button>
        <div class="muted" style="margin-top:6px;font-size:12px;">Если есть остаток — суммы оплат должны ровно совпасть с остатком. Если остаток 0 — оплаты добавлять нельзя.</div>
      </div>
      <div class="modal-row"><label>Итог доплаты сейчас (₽)</label><input id="preFinPayNow" type="number" class="money" readonly></div>
      <div class="modal-row"><label>Остаток после этой доплаты (₽)</label><input id="preFinBalanceAfter" type="number" class="money" readonly></div>
    </div>
    <div class="modal-footer"><button id="btnPreFinishSave" class="btn btn-primary">Завершить</button></div>
  </div>

  <!-- ======== Новая диагностика ======== -->
  <div id="diagNewModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="diagNewTitle">
    <div class="modal-header"><div class="modal-title" id="diagNewTitle">Новая диагностика</div><button class="btn" data-close="#diagNewModal">Закрыть</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>Дата приёма</label><input id="diagNewDate" type="date"></div>
      <div class="modal-row"><label>Магазин</label><select id="diagNewStore"></select></div>
      <div class="modal-row"><label>Сотрудник (принял)</label><select id="diagNewStaff"></select></div>
      <div class="modal-row"><label>Статус (авто «Принят»)</label><input id="diagNewStatus" type="text" readonly></div>
      <div class="modal-row"><label>Модель</label><select id="diagNewModel"></select></div>
      <div class="modal-row"><label>Память</label><select id="diagNewMemory"></select></div>
      <div class="modal-row"><label>Цвет</label><select id="diagNewColor"></select></div>
      <div class="modal-row"><label>IMEI</label><input id="diagNewImei" type="text" placeholder="IMEI (необязательно)"></div>
      <div class="modal-row"><label>Дата покупки</label><input id="diagNewPurchaseDate" type="date"></div>
      <div class="modal-row"><label>Комплектация</label><select id="diagNewComplect"></select></div>
      <div class="modal-row"><label>Неисправность</label><input id="diagNewFault" type="text" placeholder="Со слов клиента"></div>
      <div class="modal-row" style="grid-column:1/-1"><label>Внешний вид</label><textarea id="diagNewAppearance" placeholder="Царапины/сколы..."></textarea></div>
      <div class="modal-row" style="grid-column:1/-1"><label>Примечание</label><textarea id="diagNewNote"></textarea></div>
      <div class="modal-row"><label>Клиент</label><input id="diagNewCustomer" type="text"></div>
      <div class="modal-row"><label>Телефон</label><input id="diagNewPhone" type="tel"></div>
    </div>
    <div class="modal-footer"><button id="btnDiagNewSave" class="btn btn-primary">Сохранить</button></div>
  </div>

  <!-- ======== Оплаты диагностики ======== -->
  <div id="diagPaymentsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="diagPaymentsTitle">
    <div class="modal-header"><div class="modal-title" id="diagPaymentsTitle">Оплаты диагностики</div><button class="btn" data-close="#diagPaymentsModal">Закрыть</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>ID</label><input id="diagPayId" type="text" readonly></div>
      <div class="modal-row"><label>Сумма diag_pay (₽)</label><input id="diagPayTotal" type="number" step="0.01" class="money"></div>
      <div class="modal-row" style="grid-column:1/-1">
        <label>Оплаты</label>
        <div id="diagPayPaymentsList" style="display:flex;flex-direction:column;gap:6px"></div>
        <button id="btnDiagPayAddPayment" class="btn btn-small" type="button">Добавить оплату</button>
      </div>
    </div>
    <div class="modal-footer"><button id="btnDiagPaySave" class="btn btn-primary">Сохранить</button></div>
  </div>

  <!-- ======== Выдача диагностики ======== -->
  <div id="diagIssueModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="diagIssueTitle">
    <div class="modal-header"><div class="modal-title" id="diagIssueTitle">Выдача устройства</div><button class="btn" data-role="diag-issue-close" data-close="#diagIssueModal">Закрыть</button></div>
    <div class="modal-body">
      <div class="modal-row"><label>ID</label><input id="diagIssueId" type="text" readonly></div>
      <div class="modal-row"><label>Дата выдачи</label><input id="diagIssueDate" type="date"></div>
      <div class="modal-row"><label>Сотрудник (выдал)</label><select id="diagIssueStaff"></select></div>
    </div>
    <div class="modal-footer">
      <button id="btnDiagIssueSave" class="btn btn-primary">Сохранить</button>
      <button type="button" class="btn" data-role="diag-issue-close" data-close="#diagIssueModal">Отмена</button>
    </div>
  </div>

  <script>
    // ===== Быстрый прелоад и кэш-обновления =====
    window.BOOT = window.BOOT || {};
    BOOT.NALICHIE  = <?!= NALICHIE_JSON ?>;
    BOOT.DIAG      = <?!= DIAG_BOOT_JSON ?>;
    BOOT.PREORDERS = <?!= PRE_BOOT_JSON ?>;
    const NALICHIE = BOOT.NALICHIE;

    /* ===== ТЕМА ===== */
    const root=document.documentElement, themeToggle=document.getElementById('themeToggle'), themeText=document.getElementById('themeText');
    function applyTheme(theme){root.setAttribute('data-theme',theme);localStorage.setItem('theme',theme);themeToggle.checked=(theme==='dark');themeText.textContent=theme==='dark'?'Тёмная тема':'Светлая тема'}
    (function(){const s=localStorage.getItem('theme');applyTheme(s==='light'||s==='dark'?s:(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'))})();
    themeToggle.addEventListener('change',()=>applyTheme(themeToggle.checked?'dark':'light'));
    function updateHeaderHeight(){const h=document.querySelector('.header')?.offsetHeight||0;root.style.setProperty('--header-h',h+'px')}
    addEventListener('resize',updateHeaderHeight);updateHeaderHeight();

    /* ===== ВКЛАДКИ ===== */
    const tabButtons=[...document.querySelectorAll('.tab-btn')];
    const panels={nalichie:document.getElementById('tab-nalichie'),daily:document.getElementById('tab-daily'),preorder:document.getElementById('tab-preorder'),diagnostics:document.getElementById('tab-diagnostics'),shifts:document.getElementById('tab-shifts'),admin:document.getElementById('tab-admin')};
    function activateTab(key,pushHash=true){
      tabButtons.forEach(btn=>{const a=btn.dataset.tab===key;btn.setAttribute('aria-selected',String(a));if(a)btn.focus({preventScroll:true})});
      Object.entries(panels).forEach(([k,el])=>el.classList.toggle('active',k===key));
      if(pushHash)location.hash=key;
      if(key==='shifts')initShiftsUIOnce();
      if(key==='preorder')initPreorderUIOnce();
      if(key==='diagnostics')initDiagnosticsUIOnce();
    }
    tabButtons.forEach(btn=>{
      btn.addEventListener('click',()=>activateTab(btn.dataset.tab,true));
      btn.addEventListener('keydown',e=>{
        if(e.key==='ArrowRight'||e.key==='ArrowLeft'){e.preventDefault();const i=tabButtons.indexOf(btn);const n=e.key==='ArrowRight'?(i+1)%tabButtons.length:(i-1+tabButtons.length)%tabButtons.length;activateTab(tabButtons[n].dataset.tab,true)}
      });
    });
    (function(){const k=(location.hash||'').replace('#','');activateTab(panels[k]?k:'nalichie',false)})();
    addEventListener('hashchange',()=>{const k=(location.hash||'').replace('#','');if(panels[k])activateTab(k,false)});

    /* ===== НАЛИЧИЕ ===== */
    const $city=document.getElementById('fltCity'),$cond=document.getElementById('fltCondition'),$model=document.getElementById('fltModel'),$memory=document.getElementById('fltMemory'),$color=document.getElementById('fltColor'),$search=document.getElementById('searchImei'),$thead=document.getElementById('stockHeadRow'),$tbody=document.getElementById('stockTbody'),$count=document.getElementById('stockCount');
    function renderHead(){const T=NALICHIE.titles||{};const cols=[T.city||'Город',T.condition||'Состояние',T.model_name||'Модель/Название',T.memory||'Память',T.color||'Цвет',T.imei||'IMEI',T.sale_price||'Цена продажи',T.stock_statuses||'Статус склада',T.note||'Примечание','Действие'];$thead.innerHTML=cols.map(t=>`<th>${escapeHtml(t||'')}</th>`).join('')}
    function baseItems(){const src=NALICHIE.stock||[];return src.filter(it=>String(it.stock_statuses||'').trim()==='В наличии')}
    function currentFilters(){return{city_code:$city.value,condition_code:$cond.value,model_name:$model.value,memory:$memory.value,color:$color.value,imeiQuery:$search.value.trim()}}
    function applyFilters(items,f){return(items||[]).filter(it=>{if(f.city_code&&it.city_code!==f.city_code)return false;if(f.condition_code&&it.condition_code!==f.condition_code)return false;if(f.model_name&&it.model_name!==f.model_name)return false;if(f.memory&&it.memory!==f.memory)return false;if(f.color&&it.color!==f.color)return false;if(f.imeiQuery){const hay=(it.imei||'').replace(/\s+/g,'');if(!hay.includes(f.imeiQuery.replace(/\s+/g,'')))return false}return true})}
    function getItemsExcluding(key){const f=currentFilters();delete f[key];return applyFilters(baseItems(),f)}
    const option=(text,value)=>{const o=document.createElement('option');o.textContent=text;o.value=value??'';return o}
    function rebuildSelect(sel,cfg){
      const items=getItemsExcluding(cfg.excludeKey);const seen=new Set(),opts=[];
      items.forEach(it=>{const val=String(it[cfg.valueKey]??'');if(!val)return;const lbl=String((cfg.labelKey?it[cfg.labelKey]:val)??val);if(!seen.has(val)){seen.add(val);opts.push({value:val,label:lbl})}});
      opts.sort((a,b)=>a.label.localeCompare(b.label,undefined,{numeric:true,sensitivity:'base'}));
      const prev=sel.value;sel.innerHTML='';sel.append(option(cfg.placeholder,''));opts.forEach(x=>sel.append(option(x.label,x.value)));sel.value=(prev&&opts.some(x=>x.value===prev))?prev:''
    }
    function rebuildFilterOptions(){
      rebuildSelect($city,{excludeKey:'city_code',valueKey:'city_code',labelKey:'city_name',placeholder:'Все города'});
      rebuildSelect($cond,{excludeKey:'condition_code',valueKey:'condition_code',labelKey:'condition_name',placeholder:'Все состояния'});
      rebuildSelect($model,{excludeKey:'model_name',valueKey:'model_name',labelKey:null,placeholder:'Все модели'});
      rebuildSelect($memory,{excludeKey:'memory',valueKey:'memory',labelKey:null,placeholder:'Любая память'});
      rebuildSelect($color,{excludeKey:'color',valueKey:'color',labelKey:null,placeholder:'Любой цвет'});
    }
    const escapeHtml=s=>String(s??'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    function formatPrice(v){if(v==null||v==='')return'';const n=Number(v);return isNaN(n)?escapeHtml(v):n.toLocaleString('ru-RU',{maximumFractionDigits:2})}
    function renderTable(){
      const items=applyFilters(baseItems(),currentFilters());$tbody.innerHTML='';const frag=document.createDocumentFragment();
      items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(it.city_name)}</td><td>${escapeHtml(it.condition_name)}</td><td>${escapeHtml(it.model_name)}</td><td>${escapeHtml(it.memory)}</td><td>${escapeHtml(it.color)}</td><td>${escapeHtml(it.imei)}</td><td>${formatPrice(it.sale_price)}</td><td>${escapeHtml(it.stock_statuses)}</td><td>${escapeHtml(it.note)}</td><td><button class="btn btn-small btn-primary" data-action="sell">Продать</button></td>`;
        tr.querySelector('[data-action="sell"]').addEventListener('click',()=>openSaleForItem(it));frag.appendChild(tr)
      });
      $tbody.appendChild(frag);$count.textContent=`Показано позиций: ${items.length} / ${baseItems().length}`
    }
    function renderHeadAndInit(){
      renderHead();rebuildFilterOptions();renderTable();
      [$city,$cond,$model,$memory,$color].forEach(el=>el.addEventListener('change',()=>{rebuildFilterOptions();renderTable()}));
      $search.addEventListener('input',()=>{rebuildFilterOptions();renderTable()})
    }
    renderHeadAndInit();

    /* ===== Общие селекты/платежи ===== */
    function fillSelectFromDict(select,dict,placeholder){select.innerHTML='';select.append(option(placeholder,''));(dict||[]).forEach(d=>select.append(option(d.name,d.name)))}
    function fillSimpleSelect(el,arr,placeholder){el.innerHTML='';el.append(option(placeholder,''));(arr||[]).forEach(v=>el.append(option(v,v)))}
    function paymentRow(methodCode='',amount=''){const wrap=document.createElement('div');wrap.style.display='grid';wrap.style.gridTemplateColumns='1fr 140px auto';wrap.style.gap='6px';wrap.style.alignItems='center';const sel=document.createElement('select');fillSelectFromDict(sel,NALICHIE.dicts?.payments,'Способ оплаты');sel.value=methodCode||'';const sum=document.createElement('input');sum.type='number';sum.step='0.01';sum.placeholder='Сумма';sum.className='money';sum.value=amount;const del=document.createElement('button');del.type='button';del.className='btn btn-small';del.textContent='Удалить';del.addEventListener('click',()=>wrap.remove());wrap.append(sel,sum,del);return wrap}
    function todayISO(){const d=new Date();const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return`${y}-${m}-${dd}`}
    function ddmmyyyyToISODate(s){const m=String(s||'').match(/^(\d{2})\.(\d{2})\.(\d{4})$/);return m?`${m[3]}-${m[2]}-${m[1]}`:''}
    function sumPaymentList(container){const rows=[...container.children];let s=0;rows.forEach(row=>{const inp=row.querySelector('input[type="number"]');const v=Number((inp?.value||'0').toString().replace(',','.'));if(!isNaN(v))s+=v});return s}
    function parsePaymentsString(str){return String(str||'').split(/\s*(?:\+|;)\s*/).map(part=>{const chunk=part.trim();if(!chunk)return null;const match=chunk.match(/^(.+?)\s*:\s*([\d\s.,]+)$/);if(!match)return null;const method=match[1].trim();const amount=match[2].replace(/\s+/g,'').replace(/,/g,'.');return{method,amount}}).filter(Boolean)}
    function debounce(fn,ms=250){let t;return function(...args){clearTimeout(t);t=setTimeout(()=>fn.apply(this,args),ms)}}
    function ddmmyyyyToMsLocal(s){const m=String(s||'').match(/^(\d{2})\.(\d{2})\.(\d{4})$/);if(!m)return 0;return new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`).getTime()}

    // ===== Локальные фильтры для мгновенного рендера =====
    const includesCI=(hay,needle)=>!needle||String(hay||'').toLowerCase().includes(String(needle||'').toLowerCase());
    function isoToDdMmYyyy(s){const m=String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);return m?`${m[3]}.${m[2]}.${m[1]}`:s}
    function renderFromCachedRows(cacheObj,filterFn,renderFn){const source=cacheObj?.rows??[];const rows=filterFn?filterFn(source):source;renderFn({rows})}
    function applyPreFiltersLocally(rows){
      const fromMs=$preFrom.value?new Date($preFrom.value+'T00:00:00').getTime():null;
      const toMs=$preTo.value?new Date($preTo.value+'T23:59:59').getTime():null;
      const store=$preStore.value,staff=$preStaff.value,status=$preStatus.value,model=$preModel.value,memory=$preMemory.value,color=$preColor.value,cust=$preCustomer.value.trim(),phone=$prePhone.value.trim();
      return(rows||[]).filter(r=>{
        const ms=ddmmyyyyToMsLocal(r.date);
        if(fromMs&&ms<fromMs)return false;if(toMs&&ms>toMs)return false;
        if(store&&r.store!==store)return false;if(staff&&r.staff!==staff)return false;if(status&&r.preorder_statuses!==status)return false;
        if(model&&r.model_name!==model)return false;if(memory&&r.memory!==memory)return false;if(color&&r.color!==color)return false;
        if(!includesCI(r.customer,cust))return false;if(!includesCI(r.phone,phone))return false;return true
      })
    }
    function applyDiagFiltersLocally(rows){
      const fromMs=$diagFrom.value?new Date($diagFrom.value+'T00:00:00').getTime():null;
      const toMs=$diagTo.value?new Date($diagTo.value+'T23:59:59').getTime():null;
      const store=$diagStore.value,staff=$diagStaff.value,status=$diagStatus.value,model=$diagModel.value,memory=$diagMemory.value,color=$diagColor.value,cust=$diagCustomer.value.trim(),phone=$diagPhone.value.trim(),imeiQ=$diagImei.value.trim().replace(/\s+/g,''),purch=isoToDdMmYyyy($diagPurchaseDate.value);
      return(rows||[]).filter(r=>{
        const ms=ddmmyyyyToMsLocal(r.date);
        if(fromMs&&ms<fromMs)return false;if(toMs&&ms>toMs)return false;
        if(store&&r.store!==store)return false;if(staff&&r.staff!==staff)return false;if(status&&r.diagnostic_statuses!==status)return false;
        if(model&&r.model_name!==model)return false;if(memory&&r.memory!==memory)return false;if(color&&r.color!==color)return false;
        if(cust&&!includesCI(r.customer,cust))return false;if(phone&&!includesCI(r.phone,phone))return false;
        if(imeiQ&&!(String(r.imei||'').replace(/\s+/g,'').includes(imeiQ)))return false;
        if($diagPurchaseDate.value&&r.purchase_date!==purch)return false;
        return true
      })
    }
    function staffColorByName(name){const map=NALICHIE.dicts?.staffColors||{};return map[name]||'#cbd5e1'}

    function renderPreordersFiltered(){renderFromCachedRows(BOOT.PREORDERS,applyPreFiltersLocally,renderPreordersTable)}
    function renderDiagnosticsFiltered(){renderFromCachedRows(BOOT.DIAG,applyDiagFiltersLocally,renderDiagnosticsTable)}

    /* ===== Быстрые опции статусов + кэши строк ===== */
    const HTML_PRE_STATUS_OPTIONS=(NALICHIE.dicts?.preorder_statuses||[]).map(o=>`<option value="${escapeHtml(o.name)}">${escapeHtml(o.name)}</option>`).join('');
    const HTML_DIAG_STATUS_OPTIONS=(NALICHIE.dicts?.diagnostic_statuses||[]).map(o=>`<option value="${escapeHtml(o.name)}">${escapeHtml(o.name)}</option>`).join('');
    let PRE_ROWS_BY_ID=new Map(); let DIAG_ROWS_BY_ID=new Map();

    /* ===== Продажа телефона ===== */
    const $backdrop=document.getElementById('modalBackdrop');
    function openModal(el){$backdrop.classList.add('open');el.classList.add('open')}
    function closeModal(el){el.classList.remove('open');$backdrop.classList.remove('open')}
    $backdrop.addEventListener('click',()=>{document.querySelectorAll('.modal.open').forEach(x=>x.classList.remove('open'));$backdrop.classList.remove('open')});
    document.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click',e=>{const sel=e.currentTarget.getAttribute('data-close');const el=document.querySelector(sel);if(el)closeModal(el)}));

    const $sale=document.getElementById('saleModal'),$btnCloseSale=document.getElementById('btnCloseSale'),$btnSaveSale=document.getElementById('btnSaveSale'),$paymentsList=document.getElementById('paymentsList'),$btnAddPayment=document.getElementById('btnAddPayment');
    const $saleId=document.getElementById('saleId'),$saleDate=document.getElementById('saleDate'),$saleStore=document.getElementById('saleStore'),$saleStaff=document.getElementById('saleStaff'),$saleItemType=document.getElementById('saleItemType'),$saleCondition=document.getElementById('saleCondition'),$saleModel=document.getElementById('saleModel'),$saleMemory=document.getElementById('saleMemory'),$saleColor=document.getElementById('saleColor'),$saleImeiSku=document.getElementById('saleImeiSku'),$saleTotal=document.getElementById('saleTotal'),$saleSdacha=document.getElementById('saleSdacha'),$saleCustomer=document.getElementById('saleCustomer'),$salePhone=document.getElementById('salePhone'),$saleZarplata=document.getElementById('saleZarplata'),$saleNote=document.getElementById('saleNote');
    $btnCloseSale.addEventListener('click',()=>closeModal($sale));
    function initSaleDictionaries(){fillSelectFromDict($saleStore,NALICHIE.dicts?.stores,'Выбери магазин');fillSelectFromDict($saleStaff,NALICHIE.dicts?.staff,'Выбери сотрудника');fillSelectFromDict($saleCondition,NALICHIE.dicts?.conditions,'Выбери состояние')}
    const addPaymentRow=()=>{$paymentsList.append(paymentRow())}
    function openSaleForItem(it){
      initSaleDictionaries();
      $saleId.value='';$saleDate.value=todayISO();$saleStore.value='';$saleStaff.value='';
      $saleItemType.value='Телефон';$saleModel.value=it.model_name||'';$saleMemory.value=it.memory||'';$saleColor.value=it.color||'';$saleImeiSku.value=it.imei||'';$saleCondition.value=it.condition_code||'';$saleTotal.value=(it.sale_price??'').toString().replace(',','.');
      $saleSdacha.value='';$saleCustomer.value='';$salePhone.value='';$saleZarplata.value='';$saleNote.value='';
      $paymentsList.innerHTML='';addPaymentRow();openModal($sale)
    }
    document.getElementById('btnAddPayment').addEventListener('click',addPaymentRow);
    document.getElementById('btnSaveSale').addEventListener('click',()=>{
      const payments=[...$paymentsList.children].map(row=>{const sel=row.querySelector('select');const inp=row.querySelector('input[type="number"]');return{method:sel.value,amount:inp.value}}).filter(p=>p.method&&p.amount);
      const doc={id:$saleId.value,date:$saleDate.value,store:$saleStore.value,staff:$saleStaff.value,item_type:$saleItemType.value,condition:$saleCondition.value,model_name:$saleModel.value,memory:$saleMemory.value,color:$saleColor.value,imei_or_sku:$saleImeiSku.value,total:$saleTotal.value,payments,sdacha:$saleSdacha.value,customer:$saleCustomer.value,phone:$salePhone.value,zarplata:$saleZarplata.value,note:$saleNote.value};
      google.script.run
        .withSuccessHandler((res)=>{if(res&&res.ok){$saleId.value=res.id;const it=(NALICHIE.stock||[]).find(x=>(x.imei||'')===(res.imei||doc.imei_or_sku));if(it)it.stock_statuses=res.newStatus||'Продан';rebuildFilterOptions();renderTable();alert('Продажа сохранена: '+res.id);closeModal($sale)}else alert('Не удалось сохранить продажу')})
        .withFailureHandler(err=>alert('Ошибка: '+(err&&err.message?err.message:err)))
        .createSale(doc)
    });

    /* ===== Аксессуар ===== */
    const $accModal=document.getElementById('accessoryModal'),$accId=document.getElementById('accId'),$accDate=document.getElementById('accDate'),$accStore=document.getElementById('accStore'),$accStaff=document.getElementById('accStaff'),$accItemType=document.getElementById('accItemType'),$accItemSelect=document.getElementById('accItemSelect'),$accModel=document.getElementById('accModel'),$accSku=document.getElementById('accSku'),$accTotal=document.getElementById('accTotal'),$accQty=document.getElementById('accQty'),$accPaymentsList=document.getElementById('accPaymentsList'),$btnAccAddPayment=document.getElementById('btnAccAddPayment'),$accSdacha=document.getElementById('accSdacha'),$accZp=document.getElementById('accZp');
    const ACC_HAS_STORE=(NALICHIE.accessoryStock||[]).some(x=>(x.store||'').trim());
    function refreshAccessoryOptions(){
      const store=$accStore.value;$accItemSelect.innerHTML='';
      if(ACC_HAS_STORE&&!store){$accItemSelect.append(option('Сначала выберите магазин',''));$accItemSelect.disabled=true;$accModel.value='';$accSku.value='';$accTotal.value='';$accQty.value='';return}
      $accItemSelect.disabled=false;const all=NALICHIE.accessoryStock||[];const list=ACC_HAS_STORE?all.filter(x=>x.store===store):all;
      if(!list.length){$accItemSelect.append(option('Нет доступных товаров',''));$accModel.value='';$accSku.value='';$accTotal.value='';$accQty.value='';return}
      $accItemSelect.append(option('Выбери товар',''));list.forEach(x=>{$accItemSelect.append(option(`${x.model_name||'(без названия)'} — ${x.sku||'SKU?'} · ${x.qty} шт · ${x.sale_price??''}`,x.sku||''))})
    }
    function openAccessoryModal(){
      fillSelectFromDict($accStore,NALICHIE.dicts?.stores,'Выбери магазин');fillSelectFromDict($accStaff,NALICHIE.dicts?.staff,'Выбери сотрудника');
      $accItemType.value='Аксессуар';$accId.value='';$accDate.value=todayISO();
      $accModel.value='';$accSku.value='';$accTotal.value='';$accQty.value='';$accSdacha.value='';$accZp.value='';
      $accPaymentsList.innerHTML='';addAccPaymentRow();refreshAccessoryOptions();openModal($accModal)
    }
    $accStore.addEventListener('change',refreshAccessoryOptions);
    document.getElementById('btnSellAccessory').addEventListener('click',openAccessoryModal);
    $accItemSelect?.addEventListener('change',()=>{const sku=$accItemSelect.value;const x=(NALICHIE.accessoryStock||[]).find(it=>(it.sku||'')===sku);if(!x){$accModel.value='';$accSku.value='';$accTotal.value='';$accQty.value=''}else{$accModel.value=x.model_name||'';$accSku.value=x.sku||'';$accTotal.value=(x.sale_price??'').toString().replace(',','.');$accQty.value=String(x.qty??'')}})
    const addAccPaymentRow=()=>{$accPaymentsList.append(paymentRow())};$btnAccAddPayment.addEventListener('click',addAccPaymentRow);
    document.getElementById('btnSaveAccessory').addEventListener('click',()=>{
      const payments=[...$accPaymentsList.children].map(row=>{const sel=row.querySelector('select');const inp=row.querySelector('input[type="number"]');return{method:sel.value,amount:inp.value}}).filter(p=>p.method&&p.amount);
      const doc={date:$accDate.value,store:$accStore.value,staff:$accStaff.value,item_type:$accItemType.value,model_name:$accModel.value,sku:$accSku.value,imei_or_sku:$accSku.value,total:$accTotal.value,payments,qty:$accQty.value,sdacha:$accSdacha.value,zarplata:$accZp.value};
      google.script.run
        .withSuccessHandler((res)=>{if(res&&res.ok){const it=(NALICHIE.accessoryStock||[]).find(x=>(x.sku||'')===(res.sku||doc.imei_or_sku));if(it)it.qty=Math.max(0,(it.qty||0)-1);alert('Продажа аксессуара сохранена: '+res.id);closeModal($accModal)}else alert('Не удалось сохранить продажу аксессуара')})
        .withFailureHandler(err=>alert('Ошибка: '+(err&&err.message?err.message:err)))
        .createAccessorySale(doc)
    });

    /* ===== Услуга ===== */
    const $svcModal=document.getElementById('serviceModal'),$svcId=document.getElementById('svcId'),$svcDate=document.getElementById('svcDate'),$svcStore=document.getElementById('svcStore'),$svcStaff=document.getElementById('svcStaff'),$svcItemType=document.getElementById('svcItemType'),$svcModel=document.getElementById('svcModel'),$svcPaymentsList=document.getElementById('svcPaymentsList'),$btnSvcAddPayment=document.getElementById('btnSvcAddPayment'),$svcTotal=document.getElementById('svcTotal'),$svcSdacha=document.getElementById('svcSdacha'),$svcZp=document.getElementById('svcZp');
    function openServiceModal(){
      fillSelectFromDict($svcStore,NALICHIE.dicts?.stores,'Выбери магазин');fillSelectFromDict($svcStaff,NALICHIE.dicts?.staff,'Выбери сотрудника');
      $svcItemType.value='Услуга';$svcId.value='';$svcDate.value=todayISO();$svcModel.value='';$svcPaymentsList.innerHTML='';addSvcPaymentRow();recalcSvcTotal();$svcSdacha.value='';$svcZp.value='';openModal($svcModal)
    }
    document.getElementById('btnSellService').addEventListener('click',openServiceModal);
    function addSvcPaymentRow(methodCode='',amount=''){const wrap=document.createElement('div');wrap.style.display='grid';wrap.style.gridTemplateColumns='1fr 140px auto';wrap.style.gap='6px';wrap.style.alignItems='center';const sel=document.createElement('select');fillSelectFromDict(sel,NALICHIE.dicts?.payments,'Способ оплаты');sel.value=methodCode||'';const sum=document.createElement('input');sum.type='number';sum.step='0.01';sum.placeholder='Сумма';sum.className='money';sum.value=amount;const del=document.createElement('button');del.type='button';del.className='btn btn-small';del.textContent='Удалить';del.addEventListener('click',()=>{wrap.remove();recalcSvcTotal()});sel.addEventListener('change',recalcSvcTotal);sum.addEventListener('input',recalcSvcTotal);wrap.append(sel,sum,del);$svcPaymentsList.append(wrap)}
    $btnSvcAddPayment.addEventListener('click',()=>{addSvcPaymentRow();recalcSvcTotal()});
    function recalcSvcTotal(){const rows=[...$svcPaymentsList.children];let s=0;rows.forEach(row=>{const inp=row.querySelector('input[type="number"]');const v=Number((inp?.value||'0').toString().replace(',','.'));if(!isNaN(v))s+=v});$svcTotal.value=String(s)}
    document.getElementById('btnSaveService').addEventListener('click',()=>{
      const payments=[...$svcPaymentsList.children].map(row=>{const sel=row.querySelector('select');const inp=row.querySelector('input[type="number"]');return{method:sel.value,amount:inp.value}}).filter(p=>p.method&&p.amount);
      const doc={date:$svcDate.value,store:$svcStore.value,staff:$svcStaff.value,item_type:$svcItemType.value,model_name:$svcModel.value,payments,total:$svcTotal.value,sdacha:$svcSdacha.value,zarplata:$svcZp.value};
      google.script.run
        .withSuccessHandler(res=>{if(res&&res.ok){alert('Продажа услуги сохранена: '+res.id);closeModal($svcModal)}else alert('Не удалось сохранить продажу услуги')})
        .withFailureHandler(err=>alert('Ошибка: '+(err&&err.message?err.message:err)))
        .createServiceSale(doc)
    });

    /* ========================= ПРЕДЗАКАЗ: UI ========================= */
    const $preFrom=document.getElementById('preFrom'),$preTo=document.getElementById('preTo'),$preStore=document.getElementById('preStore'),$preStaff=document.getElementById('preStaff'),$preStatus=document.getElementById('preStatus'),$preModel=document.getElementById('preModel'),$preMemory=document.getElementById('preMemory'),$preColor=document.getElementById('preColor'),$preCustomer=document.getElementById('preCustomer'),$prePhone=document.getElementById('prePhone');
    const $btnPreRefresh=document.getElementById('btnPreRefresh'),$btnPreNew=document.getElementById('btnPreNew'),$preTbody=document.getElementById('preTbody'),$preSumPrice=document.getElementById('preSumPrice'),$preSumPrepay=document.getElementById('preSumPrepay'),$preSumZp=document.getElementById('preSumZp'),$preCount=document.getElementById('preCount');
    $btnPreRefresh.addEventListener('click',()=>loadPreorders());
    const $preNewModal=document.getElementById('preNewModal'),$preNewDate=document.getElementById('preNewDate'),$preNewStore=document.getElementById('preNewStore'),$preNewStaff=document.getElementById('preNewStaff'),$preNewStatus=document.getElementById('preNewStatus'),$preNewModel=document.getElementById('preNewModel'),$preNewMemory=document.getElementById('preNewMemory'),$preNewColor=document.getElementById('preNewColor'),$preNewPrice=document.getElementById('preNewPrice'),$preNewPrepay=document.getElementById('preNewPrepay'),$preNewBalance=document.getElementById('preNewBalance'),$preNewPaymentsList=document.getElementById('preNewPaymentsList'),$btnPreNewAddPay=document.getElementById('btnPreNewAddPay'),$preNewCustomer=document.getElementById('preNewCustomer'),$preNewPhone=document.getElementById('preNewPhone'),$preNewZp=document.getElementById('preNewZp'),$preNewNote=document.getElementById('preNewNote'),$btnPreNewSave=document.getElementById('btnPreNewSave');
    const $preFinModal=document.getElementById('preFinishModal'),$preFinId=document.getElementById('preFinId'),$preFinDate=document.getElementById('preFinDate'),$preFinStore=document.getElementById('preFinStore'),$preFinStaff=document.getElementById('preFinStaff'),$preFinImei=document.getElementById('preFinImei'),$preFinPrice=document.getElementById('preFinPrice'),$preFinPrepaid=document.getElementById('preFinPrepaid'),$preFinBalanceBase=document.getElementById('preFinBalanceBase'),$preFinPaymentsList=document.getElementById('preFinPaymentsList'),$btnPreFinAddPay=document.getElementById('btnPreFinAddPay'),$preFinPayNow=document.getElementById('preFinPayNow'),$preFinBalanceAfter=document.getElementById('preFinBalanceAfter'),$btnPreFinishSave=document.getElementById('btnPreFinishSave'),$btnPreFinishClose=document.getElementById('btnPreFinishClose');

    function initPreorderDicts(){
      fillSelectFromDict($preStore,NALICHIE.dicts?.stores,'Все магазины');
      fillSelectFromDict($preStaff,NALICHIE.dicts?.staff,'Все сотрудники');
      fillSelectFromDict($preStatus,NALICHIE.dicts?.preorder_statuses,'Все статусы');
      const defSt=(NALICHIE.dicts?.preorder_statuses||[]).find(x=>x.name==='Ожидание')?.name;if(defSt)$preStatus.value=defSt;
      const cat=NALICHIE.catalog||{};const fill=(el,arr,ph)=>{el.innerHTML='';el.append(option(ph,''));(arr||[]).forEach(v=>el.append(option(v,v)))};fill($preModel,cat.models,'Все модели');fill($preMemory,cat.memories,'Любая память');fill($preColor,cat.colors,'Любой цвет')
    }
    function catalogRowsByModel(model){return(NALICHIE.catalog?.table||[]).filter(r=>r.model_name===model)}
    function rebuildPreNewMemCol(){
      const rows=catalogRowsByModel($preNewModel.value);const mems=[...new Set(rows.map(r=>r.memory).filter(Boolean))].sort();const cols=[...new Set(rows.map(r=>r.color).filter(Boolean))].sort();
      const fill=(el,arr,ph)=>{el.innerHTML='';el.append(option(ph,''));arr.forEach(v=>el.append(option(v,v)))};fill($preNewMemory,mems,mems.length?'Выбери память':'—');fill($preNewColor,cols,cols.length?'Выбери цвет':'—');
      $preNewPrice.value='';recalcPreNewPrepayAndBalance()
    }
    function autofillPreNewPrice(){
      const rows=catalogRowsByModel($preNewModel.value).filter(r=>(!$preNewMemory.value||r.memory===$preNewMemory.value)&&(!$preNewColor.value||r.color===$preNewColor.value));
      const hit=rows.find(r=>r.pre_price!==''&&r.pre_price!=null);if(hit)$preNewPrice.value=String(hit.pre_price).toString().replace(',','.');recalcPreNewPrepayAndBalance()
    }
    function recalcPreNewPrepayAndBalance(){
      const paid=sumPaymentList($preNewPaymentsList);$preNewPrepay.value=String(paid);
      const price=Number(($preNewPrice.value||'').toString().replace(',','.'));if(isNaN(price)||!isFinite(price)){$preNewBalance.value='';return}
      $preNewBalance.value=String(Math.round((price-paid)*100)/100)
    }
    function initPreNewModal(){
      fillSelectFromDict($preNewStore,NALICHIE.dicts?.stores,'Выбери магазин');fillSelectFromDict($preNewStaff,NALICHIE.dicts?.staff,'Выбери сотрудника');
      const def=(NALICHIE.dicts?.preorder_statuses||[]).find(x=>x.name==='Ожидание')?.name||(NALICHIE.dicts?.preorder_statuses?.[0]?.name||'Ожидание');$preNewStatus.value=def;
      const cat=NALICHIE.catalog||{};const fill=(el,arr,ph)=>{el.innerHTML='';el.append(option(ph,''));(arr||[]).forEach(v=>el.append(option(v,v)))};fill($preNewModel,cat.models,'Выбери модель');fill($preNewMemory,[],'—');fill($preNewColor,[],'—');
      $preNewDate.value=todayISO();$preNewPrice.value='';$preNewPrepay.value='';$preNewBalance.value='';$preNewCustomer.value='';$preNewPhone.value='';$preNewZp.value='';$preNewNote.value='';$preNewPaymentsList.innerHTML='';$preNewPaymentsList.append(paymentRow());
      $preNewModel.onchange=rebuildPreNewMemCol;$preNewMemory.onchange=autofillPreNewPrice;$preNewColor.onchange=autofillPreNewPrice;
      $preNewPrice.oninput=recalcPreNewPrepayAndBalance;$preNewPaymentsList.oninput=recalcPreNewPrepayAndBalance;$preNewPaymentsList.onchange=recalcPreNewPrepayAndBalance;
      rebuildPreNewMemCol();recalcPreNewPrepayAndBalance()
    }
    const openPreNew=()=>{initPreNewModal();openModal($preNewModal)};$btnPreNew.addEventListener('click',openPreNew);
    $btnPreNewAddPay.addEventListener('click',()=> $preNewPaymentsList.append(paymentRow()));
    $btnPreNewSave.addEventListener('click',()=>{
      const payments=[...$preNewPaymentsList.children].map(row=>{const sel=row.querySelector('select');const inp=row.querySelector('input[type="number"]');return{method:sel.value,amount:inp.value}}).filter(p=>p.method&&p.amount);
      const doc={date:$preNewDate.value,store:$preNewStore.value,staff:$preNewStaff.value,preorder_statuses:$preNewStatus.value,model_name:$preNewModel.value,memory:$preNewMemory.value,color:$preNewColor.value,pre_price:$preNewPrice.value,prepay:$preNewPrepay.value,payments,customer:$preNewCustomer.value,phone:$preNewPhone.value,zarplata:$preNewZp.value,note:$preNewNote.value};
      if(!doc.store||!doc.staff){alert('Выберите магазин и сотрудника');return}
      google.script.run
        .withSuccessHandler(res=>{if(res?.ok){closeModal($preNewModal);loadPreorders()}else alert('Не удалось создать предзаказ')})
        .withFailureHandler(err=>alert('Ошибка: '+(err?.message||err)))
        .createPreorder(doc)
    });

    // ===== Завершение предзаказа =====
    const preFinCtx={row:null,revert:null,basePrice:0,basePaid:0,baseBalance:0,saved:false};
    function recalcPreFin(){const sum=sumPaymentList($preFinPaymentsList);$preFinPayNow.value=String(sum);const after=Math.round((preFinCtx.basePrice-(preFinCtx.basePaid+sum))*100)/100;$preFinBalanceAfter.value=String(after)}
    function openPreFinish(row,revertCb){
      preFinCtx.row=row;preFinCtx.revert=revertCb;preFinCtx.saved=false;fillSelectFromDict($preFinStaff,NALICHIE.dicts?.staff,'Выбери сотрудника');
      const price=Number((row.pre_price??0).toString().replace(',','.'))||0;const paid=Number((row.prepay??0).toString().replace(',','.'))||0;const bal=Math.max(0,Math.round((price-paid)*100)/100);
      preFinCtx.basePrice=price;preFinCtx.basePaid=paid;preFinCtx.baseBalance=bal;
      $preFinId.value=row.id||'';$preFinDate.value=todayISO();$preFinStore.value=row.store||'';$preFinStaff.value=row.staff||'';$preFinImei.value=row.pre_imei||'';$preFinPrice.value=String(price);$preFinPrepaid.value=String(paid);$preFinBalanceBase.value=String(bal);
      $preFinPaymentsList.innerHTML='';if(bal>0){const defMethod=(NALICHIE.dicts?.payments?.[0]?.name)||'';$preFinPaymentsList.append(paymentRow(defMethod,String(bal)))}
      $preFinPaymentsList.oninput=recalcPreFin;$preFinPaymentsList.onchange=recalcPreFin;recalcPreFin();openModal($preFinModal)
    }
    document.getElementById('btnPreFinAddPay').addEventListener('click',()=> $preFinPaymentsList.append(paymentRow()));
    $btnPreFinishSave.addEventListener('click',()=>{
      const row=preFinCtx.row||{};const imei=($preFinImei.value||'').trim();if(!imei){alert('IMEI обязателен для завершения');return}
      const dateStr=$preFinDate.value||todayISO();const staffFin=$preFinStaff.value||row.staff||'';if(!staffFin){alert('Выберите сотрудника, кто завершил');return}
      const payments=[...$preFinPaymentsList.children].map(row=>{const sel=row.querySelector('select');const inp=row.querySelector('input[type="number"]');return{method:sel.value,amount:inp.value}}).filter(p=>p.method&&p.amount);
      const paySum=payments.reduce((s,p)=>s+Number((p.amount||'0').toString().replace(',','.')),0);const need=preFinCtx.baseBalance;
      if(need>0){if(!(paySum>0)){alert('Требуется внести доплату: '+need);return}if(Math.abs(paySum-need)>0.01){alert('Сумма оплат должна совпасть с остатком: '+need);return}}
      else{if(paySum>0){alert('Оплата не требуется: остаток уже 0');return}}
      $btnPreFinishSave.disabled=true;
      google.script.run
        .withSuccessHandler(()=>{$btnPreFinishSave.disabled=false;closeModal($preFinModal);loadPreorders()})
        .withFailureHandler(err=>{$btnPreFinishSave.disabled=false;alert('Ошибка: '+(err?.message||err))})
        .finalizePreorder({id:row.id,date:dateStr,store:row.store,staff:staffFin,pre_imei:imei,payments})
    });
    $btnPreFinishClose.addEventListener('click',()=>{/* откат снаружи */});

    // ===== РЕНДЕР ПРЕДЗАКАЗОВ (улучшенный) =====
    function renderPreordersTable(data){
      const rows=(data?.rows||[]).slice().sort((a,b)=>ddmmyyyyToMsLocal(b.date)-ddmmyyyyToMsLocal(a.date));
      PRE_ROWS_BY_ID=new Map(rows.map(r=>[String(r.id),r]));
      let sumPrice=0,sumPrepay=0,sumZp=0;
      const html=rows.map(r=>{
        sumPrice+=Number(r.pre_price||0);sumPrepay+=Number(r.prepay||0);sumZp+=Number(r.zarplata||0);
        const price=Number((r.pre_price??0).toString().replace(',','.'))||0;const paid=Number((r.prepay??0).toString().replace(',','.'))||0;const bal=Math.round((price-paid)*100)/100;
        const balCell=isNaN(bal)?'—':(Math.abs(bal)<0.005?'Оплачено':formatPrice(bal));
        const isCompleted=!!r.completed_at;const dotColor=r.staff_color||(NALICHIE.dicts?.staffColors?.[r.staff])||staffColorByName(r.staff);const staffDot=`<span class="dot" style="background:${escapeHtml(dotColor)};"></span>`;const badge=isCompleted?'✅':'';
        return `
          <tr data-row-id="${escapeHtml(String(r.id))}">
            <td>${escapeHtml(r.date)}</td><td>${escapeHtml(r.store)}</td><td>${staffDot}${escapeHtml(r.staff)}</td>
            <td>${escapeHtml(r.model_name)}</td><td>${escapeHtml(r.memory)}</td><td>${escapeHtml(r.color)}</td>
            <td>${escapeHtml(r.pre_imei||'Не указан')}</td>
            <td class="money">${formatPrice(r.pre_price)}</td>
            <td class="money">${formatPrice(r.prepay)}</td>
            <td class="money">${balCell}</td>
            <td>${escapeHtml(r.payments||'')}</td>
            <td>${escapeHtml(r.customer||'')}</td>
            <td>${escapeHtml(r.phone||'')}</td>
            <td class="money">${formatPrice(r.zarplata)}</td>
            <td>${escapeHtml(r.note||'')}</td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                <select data-role="pre-status" data-row-id="${escapeHtml(String(r.id))}" ${isCompleted?'disabled':''}>${HTML_PRE_STATUS_OPTIONS}</select> ${badge}
              </div>
              ${isCompleted?`<div class="muted" style="font-size:12px;margin-top:2px;">Завершил: ${escapeHtml(r.completed_by||'—')} · ${escapeHtml(r.completed_at||'')}</div>`:''}
            </td>
          </tr>`;
      }).join('');
      $preTbody.innerHTML=html;
      [...$preTbody.querySelectorAll('select[data-role="pre-status"]')].forEach(sel=>{const row=PRE_ROWS_BY_ID.get(sel.dataset.rowId);sel.value=row?.preorder_statuses||''});
      $preSumPrice.textContent=formatPrice(sumPrice);$preSumPrepay.textContent=formatPrice(sumPrepay);$preSumZp.textContent=formatPrice(sumZp);$preCount.textContent=`Заявок: ${rows.length}`
    }

    // ==== БЫСТРАЯ ЗАГРУЗКА ПРЕДЗАКАЗОВ ====
    function loadPreorders(){
      $btnPreRefresh.disabled=true;
      google.script.run
        .withSuccessHandler(data=>{BOOT.PREORDERS=data||{rows:[]};$btnPreRefresh.disabled=false;renderPreordersFiltered()})
        .withFailureHandler(err=>{$btnPreRefresh.disabled=false;alert('Ошибка: '+(err?.message||err))})
        .getPreordersBootstrap()
    }
    function initPreorderAutorefresh(){
      const debouncedRenderPreorders=debounce(renderPreordersFiltered,250);const on=(el,ev='change')=>el&&el.addEventListener(ev,debouncedRenderPreorders);
      function rebuildPreFiltersMemCol(){const rows=catalogRowsByModel($preModel.value);const mems=[...new Set(rows.map(r=>r.memory).filter(Boolean))].sort();const cols=[...new Set(rows.map(r=>r.color).filter(Boolean))].sort();fillSimpleSelect($preMemory,mems,'Любая память');fillSimpleSelect($preColor,cols,'Любой цвет')}
      $preModel.addEventListener('change',()=>{rebuildPreFiltersMemCol();debouncedRenderPreorders()});
      on($preFrom);on($preTo);on($preStore);on($preStaff);on($preStatus);on($preMemory);on($preColor);on($preCustomer,'input');on($prePhone,'input')
    }
    let preInitDone=false;
    function initPreorderUIOnce(){
      if(preInitDone)return;preInitDone=true;initPreorderDicts();$preFrom.value='';$preTo.value='';
      renderPreordersFiltered();
      initPreorderAutorefresh();loadPreorders()
    }

    /* ========================= ДИАГНОСТИКА: UI ========================= */
    const $diagFrom=document.getElementById('diagFrom'),$diagTo=document.getElementById('diagTo'),$diagStore=document.getElementById('diagStore'),$diagStaff=document.getElementById('diagStaff'),$diagStatus=document.getElementById('diagStatus'),$diagModel=document.getElementById('diagModel'),$diagMemory=document.getElementById('diagMemory'),$diagColor=document.getElementById('diagColor'),$diagCustomer=document.getElementById('diagCustomer'),$diagPhone=document.getElementById('diagPhone'),$diagImei=document.getElementById('diagImei'),$diagPurchaseDate=document.getElementById('diagPurchaseDate');
    const $btnDiagRefresh=document.getElementById('btnDiagRefresh'),$btnDiagNew=document.getElementById('btnDiagNew'),$diagTbody=document.getElementById('diagTbody'),$diagSumPaid=document.getElementById('diagSumPaid'),$diagCount=document.getElementById('diagCount');
    $btnDiagRefresh.addEventListener('click',()=>loadDiagnostics());
    const $diagNewModal=document.getElementById('diagNewModal'),$diagNewDate=document.getElementById('diagNewDate'),$diagNewStore=document.getElementById('diagNewStore'),$diagNewStaff=document.getElementById('diagNewStaff'),$diagNewStatus=document.getElementById('diagNewStatus'),$diagNewModel=document.getElementById('diagNewModel'),$diagNewMemory=document.getElementById('diagNewMemory'),$diagNewColor=document.getElementById('diagNewColor'),$diagNewImei=document.getElementById('diagNewImei'),$diagNewPurchaseDate=document.getElementById('diagNewPurchaseDate'),$diagNewComplect=document.getElementById('diagNewComplect'),$diagNewFault=document.getElementById('diagNewFault'),$diagNewAppearance=document.getElementById('diagNewAppearance'),$diagNewNote=document.getElementById('diagNewNote'),$diagNewCustomer=document.getElementById('diagNewCustomer'),$diagNewPhone=document.getElementById('diagNewPhone'),$btnDiagNewSave=document.getElementById('btnDiagNewSave');
    const $diagPaymentsModal=document.getElementById('diagPaymentsModal'),$diagPayId=document.getElementById('diagPayId'),$diagPayTotal=document.getElementById('diagPayTotal'),$diagPayPaymentsList=document.getElementById('diagPayPaymentsList'),$btnDiagPayAddPayment=document.getElementById('btnDiagPayAddPayment'),$btnDiagPaySave=document.getElementById('btnDiagPaySave');
    const $diagIssueModal=document.getElementById('diagIssueModal'),$diagIssueId=document.getElementById('diagIssueId'),$diagIssueDate=document.getElementById('diagIssueDate'),$diagIssueStaff=document.getElementById('diagIssueStaff'),$btnDiagIssueSave=document.getElementById('btnDiagIssueSave');

    function initDiagnosticsDictionaries(){
      fillSelectFromDict($diagStore,NALICHIE.dicts?.stores,'Все магазины');fillSelectFromDict($diagStaff,NALICHIE.dicts?.staff,'Все сотрудники');fillSelectFromDict($diagStatus,NALICHIE.dicts?.diagnostic_statuses,'Все статусы');
      const defSt=(NALICHIE.dicts?.diagnostic_statuses||[]).find(x=>x.name==='Принят')?.name;if(defSt)$diagStatus.value=defSt;
      const cat=NALICHIE.catalog||{};fillSimpleSelect($diagModel,cat.models,'Все модели');fillSimpleSelect($diagMemory,[],'Любая память');fillSimpleSelect($diagColor,[],'Любой цвет');
      $diagModel.onchange=rebuildDiagFiltersMemCol;rebuildDiagFiltersMemCol()
    }
    function rebuildDiagFiltersMemCol(){const rows=catalogRowsByModel($diagModel.value);const mems=[...new Set(rows.map(r=>r.memory).filter(Boolean))].sort();const cols=[...new Set(rows.map(r=>r.color).filter(Boolean))].sort();fillSimpleSelect($diagMemory,mems,'Любая память');fillSimpleSelect($diagColor,cols,'Любой цвет')}
    function rebuildDiagNewMemCol(){const rows=catalogRowsByModel($diagNewModel.value);const mems=[...new Set(rows.map(r=>r.memory).filter(Boolean))].sort();const cols=[...new Set(rows.map(r=>r.color).filter(Boolean))].sort();fillSimpleSelect($diagNewMemory,mems,mems.length?'Выбери память':'—');fillSimpleSelect($diagNewColor,cols,cols.length?'Выбери цвет':'—')}
    function openDiagNew(){
      fillSelectFromDict($diagNewStore,NALICHIE.dicts?.stores,'Выбери магазин');fillSelectFromDict($diagNewStaff,NALICHIE.dicts?.staff,'Выбери сотрудника');fillSelectFromDict($diagNewComplect,NALICHIE.dicts?.complects,'Выбери комплектацию');$diagNewComplect.value='';
      const def=(NALICHIE.dicts?.diagnostic_statuses||[]).find(x=>x.name==='Принят')?.name||(NALICHIE.dicts?.diagnostic_statuses?.[0]?.name||'Принят');$diagNewStatus.value=def;
      const cat=NALICHIE.catalog||{};fillSimpleSelect($diagNewModel,cat.models,'Выбери модель');fillSimpleSelect($diagNewMemory,[],'—');fillSimpleSelect($diagNewColor,[],'—');
      $diagNewModel.onchange=rebuildDiagNewMemCol;rebuildDiagNewMemCol();
      $diagNewDate.value=todayISO();$diagNewImei.value='';$diagNewPurchaseDate.value='';$diagNewFault.value='';$diagNewAppearance.value='';$diagNewNote.value='';$diagNewCustomer.value='';$diagNewPhone.value='';
      openModal($diagNewModal)
    }
    $btnDiagNew.addEventListener('click',openDiagNew);
    $btnDiagNewSave.addEventListener('click',()=>{
      const doc={date:$diagNewDate.value,store:$diagNewStore.value,staff:$diagNewStaff.value,diagnostic_statuses:$diagNewStatus.value,model_name:$diagNewModel.value,memory:$diagNewMemory.value,color:$diagNewColor.value,imei:$diagNewImei.value,purchase_date:$diagNewPurchaseDate.value,complect:$diagNewComplect.value,neispravnost:$diagNewFault.value,appearance:$diagNewAppearance.value,note:$diagNewNote.value,customer:$diagNewCustomer.value,phone:$diagNewPhone.value};
      if(!doc.store||!doc.staff){alert('Выберите магазин и сотрудника');return}
      google.script.run
        .withSuccessHandler(res=>{if(res&&res.ok){closeModal($diagNewModal);loadDiagnostics()}else alert('Не удалось создать диагностику')})
        .withFailureHandler(err=>alert('Ошибка: '+(err?.message||err)))
        .createDiagnostic(doc)
    });

    // ===== Оплаты диагностики =====
    const diagPayCtx={row:null};
    function recalcDiagPayments(){const rows=[...$diagPayPaymentsList.children];let sum=0,count=0;rows.forEach(row=>{const inp=row.querySelector('input[type="number"]');const raw=(inp?.value??'').toString().trim();if(!raw)return;const num=Number(raw.replace(',','.'));if(!isNaN(num)){sum+=num;count++;}});if(count>0){$diagPayTotal.value=String(Math.round(sum*100)/100)}}
    function normalizeDiagPayValue(v){if(v==null)return'';const raw=String(v).trim();if(!raw)return'';const num=Number(raw.replace(/\s+/g,'').replace(',','.'));return isNaN(num)?raw:String(num)}
    function openDiagPayments(row){diagPayCtx.row=row||null;$diagPayId.value=row?.id||'';$diagPayTotal.value=normalizeDiagPayValue(row?.diag_pay);$diagPayPaymentsList.innerHTML='';const parsed=parsePaymentsString(row?.payments);if(parsed.length){parsed.forEach(p=>$diagPayPaymentsList.append(paymentRow(p.method,p.amount)))}else{$diagPayPaymentsList.append(paymentRow())}$diagPayPaymentsList.oninput=$diagPayPaymentsList.onchange=recalcDiagPayments;recalcDiagPayments();openModal($diagPaymentsModal)}
    $btnDiagPayAddPayment.addEventListener('click',()=>{$diagPayPaymentsList.append(paymentRow());recalcDiagPayments()});
    $btnDiagPaySave.addEventListener('click',()=>{if(!diagPayCtx.row){closeModal($diagPaymentsModal);return}const payments=[...$diagPayPaymentsList.children].map(row=>{const sel=row.querySelector('select');const inp=row.querySelector('input[type="number"]');return{method:sel.value,amount:inp.value}}).filter(p=>p.method&&p.amount);const diagPayValue=normalizeDiagPayValue($diagPayTotal.value);$btnDiagPaySave.disabled=true;google.script.run.withSuccessHandler(()=>{$btnDiagPaySave.disabled=false;closeModal($diagPaymentsModal);diagPayCtx.row=null;loadDiagnostics()}).withFailureHandler(err=>{$btnDiagPaySave.disabled=false;alert('Ошибка: '+(err?.message||err))}).updateDiagnosticPayment({id:diagPayCtx.row.id,diag_pay:diagPayValue,payments})});

    // ===== Выдача диагностики =====
    const diagIssueCtx={row:null,select:null};
    function openDiagIssue(row,select){
      diagIssueCtx.row=row||null;diagIssueCtx.select=select||null;
      fillSelectFromDict($diagIssueStaff,NALICHIE.dicts?.staff,'Выберите сотрудника');
      $diagIssueId.value=row?.id||'';
      const isoDate=ddmmyyyyToISODate(row?.issued_date||row?.completed_at)||todayISO();
      $diagIssueDate.value=isoDate||todayISO();
      const staffValue=row?.issued_staff||row?.completed_by||row?.staff||'';
      $diagIssueStaff.value=staffValue;
      openModal($diagIssueModal);
    }
    document.querySelectorAll('[data-role="diag-issue-close"]').forEach(btn=>btn.addEventListener('click',()=>{diagIssueCtx.row=null;diagIssueCtx.select=null;}));
    $btnDiagIssueSave.addEventListener('click',()=>{
      if(!diagIssueCtx.row){closeModal($diagIssueModal);return}
      const dateVal=$diagIssueDate.value||'';
      const staffVal=$diagIssueStaff.value||'';
      if(!dateVal){alert('Укажите дату выдачи');return}
      if(!staffVal){alert('Выберите сотрудника выдачи');return}
      $btnDiagIssueSave.disabled=true;
      google.script.run
        .withSuccessHandler(()=>{$btnDiagIssueSave.disabled=false;closeModal($diagIssueModal);diagIssueCtx.row=null;diagIssueCtx.select=null;loadDiagnostics()})
        .withFailureHandler(err=>{$btnDiagIssueSave.disabled=false;alert('Ошибка: '+(err?.message||err))})
        .updateDiagnosticStatus({id:diagIssueCtx.row.id,diagnostic_statuses:'Выдан',issued_date:dateVal,issued_staff:staffVal});
    });

    // ===== РЕНДЕР ДИАГНОСТИКИ (улучшенный) =====
    function renderDiagnosticsTable(data){
      const rows=(data?.rows||[]).slice().sort((a,b)=>ddmmyyyyToMsLocal(b.date)-ddmmyyyyToMsLocal(a.date));
      DIAG_ROWS_BY_ID=new Map(rows.map(r=>[String(r.id),r]));
      let sumPaid=0;
      const html=rows.map(r=>{
        const diagPayNum=Number(String(r.diag_pay??'').toString().replace(/\s+/g,'').replace(',','.'))||0;sumPaid+=diagPayNum;
        const dotColor=r.staff_color||staffColorByName(r.staff);const staffDot=`<span class="dot" style="background:${escapeHtml(dotColor)};"></span>`;
        const issuedBy=r.issued_staff||r.completed_by||'';const issuedAt=r.issued_date||r.completed_at||'';
        const statusInfo=(issuedBy||issuedAt)?`<div class="muted" style="font-size:12px;margin-top:2px;">Выдал: ${escapeHtml(issuedBy||'—')} · ${escapeHtml(issuedAt||'')}</div>`:'';
        const isIssued=(String(r.diagnostic_statuses||'').toLowerCase()==='выдан');
        const badge=isIssued?'✅':'';
        const selectDisabled=isIssued?' disabled="disabled"':'';
        return `
          <tr data-row-id="${escapeHtml(String(r.id))}">
            <td>${escapeHtml(r.date||'')}</td><td>${escapeHtml(r.store||'')}</td><td>${staffDot}${escapeHtml(r.staff||'')}</td>
            <td>${escapeHtml(r.model_name||'')}</td><td>${escapeHtml(r.memory||'')}</td><td>${escapeHtml(r.color||'')}</td>
            <td>${escapeHtml(r.imei||'')}</td><td>${escapeHtml(r.purchase_date||'')}</td>
            <td class="money">${formatPrice(r.diag_pay)}</td>
            <td>${escapeHtml(r.payments||'')}</td><td>${escapeHtml(r.customer||'')}</td><td>${escapeHtml(r.phone||'')}</td>
            <td>${escapeHtml(r.complect||'')}</td><td>${escapeHtml(r.appearance||'')}</td><td>${escapeHtml(r.neispravnost||'')}</td><td>${escapeHtml(r.note||'')}</td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                <select data-role="diag-status" data-row-id="${escapeHtml(String(r.id))}"${selectDisabled}>${HTML_DIAG_STATUS_OPTIONS}</select> ${badge}
                <button type="button" class="btn btn-small" data-role="diag-pay" data-row-id="${escapeHtml(String(r.id))}">Оплаты</button>
              </div>
              ${statusInfo}
            </td>
          </tr>`;
      }).join('');
      $diagTbody.innerHTML=html;
      [...$diagTbody.querySelectorAll('select[data-role="diag-status"]')].forEach(sel=>{const row=DIAG_ROWS_BY_ID.get(sel.dataset.rowId);sel.value=row?.diagnostic_statuses||''});
      $diagSumPaid.textContent=formatPrice(sumPaid);$diagCount.textContent=`Заявок: ${rows.length}`
    }

    // ==== БЫСТРАЯ ЗАГРУЗКА ДИАГНОСТИКИ ====
    function loadDiagnostics(){
      $btnDiagRefresh.disabled=true;
      google.script.run
        .withSuccessHandler(data=>{BOOT.DIAG=data||{rows:[]};$btnDiagRefresh.disabled=false;renderDiagnosticsFiltered()})
        .withFailureHandler(err=>{$btnDiagRefresh.disabled=false;alert('Ошибка: '+(err?.message||err))})
        .getDiagnosticsBootstrap()
    }
    function initDiagnosticsAutorefresh(){
      const debouncedRenderDiagnostics=debounce(renderDiagnosticsFiltered,250);const on=(el,ev='change')=>el&&el.addEventListener(ev,debouncedRenderDiagnostics);
      $diagModel.addEventListener('change',()=>{rebuildDiagFiltersMemCol();debouncedRenderDiagnostics()});
      on($diagFrom);on($diagTo);on($diagStore);on($diagStaff);on($diagStatus);on($diagMemory);on($diagColor);on($diagCustomer,'input');on($diagPhone,'input');on($diagImei,'input');on($diagPurchaseDate,'change')
    }
    let diagInitDone=false;
    function initDiagnosticsUIOnce(){
      if(diagInitDone)return;diagInitDone=true;initDiagnosticsDictionaries();$diagFrom.value='';$diagTo.value='';
      renderDiagnosticsFiltered();
      initDiagnosticsAutorefresh();loadDiagnostics()
    }

    // === Device type helper (ПК / Смартфон) ===
    function getDeviceType(){
      const ua=(navigator.userAgent||'').toLowerCase();
      const isPhone=(navigator.userAgentData?.mobile===true)||/\b(mobi|iphone|ipod|android.*mobile)\b/.test(ua);
      const isTablet=/\b(ipad|tablet)\b/.test(ua)||(/android/.test(ua)&&!/mobile/.test(ua));
      if(isPhone&&!isTablet)return'Смартфон';return'ПК'
    }

    /* ========================= СМЕНЫ: UI ========================= */
    const $shiftStore=document.getElementById('shiftStore'),$shiftStaff=document.getElementById('shiftStaff'),$shiftDateAuto=document.getElementById('shiftDateAuto'),$shiftTimeAuto=document.getElementById('shiftTimeAuto'),$btnShiftCheckIn=document.getElementById('btnShiftCheckIn'),$lastCheckLabel=document.getElementById('lastCheckLabel');
    const $ledgerFrom=document.getElementById('ledgerFrom'),$ledgerTo=document.getElementById('ledgerTo'),$ledgerStore=document.getElementById('ledgerStore'),$ledgerStaff=document.getElementById('ledgerStaff'),$btnLedgerUpdate=document.getElementById('btnLedgerUpdate');
    const $shiftDays=document.getElementById('shiftDays'),$shiftGrandTotal=document.getElementById('shiftGrandTotal');

    function renderShiftsTable(data){
      const rows=(data?.rows||[]).slice().sort((a,b)=>{
        const ma=ddmmyyyyToMsLocal(a.date),mb=ddmmyyyyToMsLocal(b.date);
        if(mb!==ma)return mb-ma;
        const toMin=s=>{
          const m=(s||'').match(/^(\d{2}):(\d{2})$/);
          return m?(+m[1])*60+(+m[2]):-1;
        };
        const ta=toMin(a.startTime),tb=toMin(b.startTime);
        if(tb!==ta)return tb-ta;
        return (a.store||'').localeCompare(b.store||'')||(a.staff||'').localeCompare(b.staff||'');
      });
      const groups=[];
      rows.forEach(r=>{
        const dateKey=r.date||'';
        let group=groups[groups.length-1];
        if(!group||group.date!==dateKey){
          group={date:dateKey,items:[]};
          groups.push(group);
        }
        group.items.push(r);
      });
      $shiftDays.innerHTML='';
      $shiftGrandTotal.innerHTML='';
      const fragment=document.createDocumentFragment();
      const toNumber=v=>{
        if(v==null||v==='')return 0;
        if(typeof v==='number')return Number.isFinite(v)?v:0;
        const normalized=String(v).replace(/\s+/g,'').replace(',', '.');
        const n=Number(normalized);
        return Number.isFinite(n)?n:0;
      };
      const hasNumericValue=v=>!(v==null||v==='');
      const formatMoney=value=>{
        if(!hasNumericValue(value)&&value!==0)return'—';
        const num=toNumber(value);
        if(!Number.isFinite(num))return'—';
        return`${formatPrice(num)} ₽`;
      };
      const weekdayFormatter=renderShiftsTable._weekdayFormatter||(renderShiftsTable._weekdayFormatter=new Intl.DateTimeFormat('ru-RU',{weekday:'short'}));
      const countFormatter=renderShiftsTable._countFormatter||(renderShiftsTable._countFormatter=new Intl.NumberFormat('ru-RU',{maximumFractionDigits:0}));
      const formatCount=value=>{
        if(value==null||!Number.isFinite(value))return'—';
        return countFormatter.format(value);
      };
      const normalizePositions=pos=>{
        if(!pos)return null;
        const keys=['phones','accessories','services','preorders'];
        const normalized={};
        let has=false;
        keys.forEach(key=>{
          if(Object.prototype.hasOwnProperty.call(pos,key)){
            normalized[key]=toNumber(pos[key]);
            has=true;
          }else{
            normalized[key]=null;
          }
        });
        return has?normalized:null;
      };
      const hasOwnProp=(obj,key)=>Object.prototype.hasOwnProperty.call(obj,key);
      const extractCount=(obj,keys)=>{
        if(!obj)return{value:0,found:false};
        for(const key of keys){
          const containers=[obj.counts,obj];
          for(const container of containers){
            if(!container)continue;
            if(hasOwnProp(container,key))return{value:toNumber(container[key]),found:true};
            const alt=key.endsWith('_count')?key:`${key}_count`;
            if(hasOwnProp(container,alt))return{value:toNumber(container[alt]),found:true};
          }
        }
        return{value:0,found:false};
      };
      const makeCountsBucket=()=>({
        phones:{value:0,found:false},
        accessories:{value:0,found:false},
        services:{value:0,found:false},
        preorders:{value:0,found:false}
      });
      const addCount=(bucket,key,info)=>{
        if(!info||!info.found)return;
        const target=bucket[key];
        target.value+=info.value;
        target.found=true;
      };
      const renderPositionsList=counts=>{
        const parts=[
          {key:'phones',icon:'📱',label:'Тел'},
          {key:'accessories',icon:'🎧',label:'Акс'},
          {key:'services',icon:'🛠️',label:'Усл'},
          {key:'preorders',icon:'📦',label:'Пред'}
        ];
        return`<div class="shift-positions">${parts.map(({key,icon,label})=>{
          const info=counts?.[key];
          const found=info?.found;
          const valueText=found?formatCount(info.value):'—';
          const emptyClass=found?'':' shift-position-empty';
          return`<span class="shift-position${emptyClass}"><span class="shift-position-icon">${icon}</span><span class="shift-position-label">${escapeHtml(label)}</span><span class="shift-position-value">${escapeHtml(valueText)}</span></span>`;
        }).join('')}</div>`;
      };
      const renderMetric=(label,value,{money=false,accent=false}={})=>{
        const classes=['shift-metric'];
        if(accent)classes.push('shift-metric-accent');
        const valueClasses=['shift-metric-value'];
        if(money)valueClasses.push('money');
        return`<div class="${classes.join(' ')}"><span class="shift-metric-label">${escapeHtml(label)}</span><span class="${valueClasses.join(' ')}">${escapeHtml(value)}</span></div>`;
      };
      const positionsGrandTotals=makeCountsBucket();
      const aggregatedTotals={phones:0,accessories:0,services:0,salesTotal:0,preorders:0,salary:0};
      if(groups.length===0){
        const empty=document.createElement('div');
        empty.className='shift-day-empty';
        empty.textContent='Нет данных за выбранный период';
        fragment.appendChild(empty);
      }else{
        groups.forEach(group=>{
          const subtotal=group.items.reduce((acc,item)=>{
            const sales=item.sales||{};
            const preorders=item.preorders||{};
            const salary=item.salary||{};
            acc.phones+=toNumber(sales.phones);
            acc.accessories+=toNumber(sales.accessories);
            acc.services+=toNumber(sales.services);
            acc.salesTotal+=toNumber(sales.total);
            acc.preorders+=toNumber(preorders.total);
            acc.salary+=toNumber(salary.total);
            return acc;
          },{phones:0,accessories:0,services:0,salesTotal:0,preorders:0,salary:0});
          aggregatedTotals.phones+=subtotal.phones;
          aggregatedTotals.accessories+=subtotal.accessories;
          aggregatedTotals.services+=subtotal.services;
          aggregatedTotals.salesTotal+=subtotal.salesTotal;
          aggregatedTotals.preorders+=subtotal.preorders;
          aggregatedTotals.salary+=subtotal.salary;
          const dayEl=document.createElement('section');
          dayEl.className='shift-day';
          let weekday='—';
          if(group.date){
            const ms=ddmmyyyyToMsLocal(group.date);
            if(ms){
              const raw=weekdayFormatter.format(new Date(ms)).replace(/\.$/,'');
              if(raw)weekday=raw.charAt(0).toUpperCase()+raw.slice(1);
            }
          }
          const header=document.createElement('div');
          header.className='shift-day-header';
          const headerMain=document.createElement('div');
          headerMain.className='shift-day-header-main';
          headerMain.innerHTML=`<div class="shift-day-date">${escapeHtml(group.date||'—')}</div><div class="shift-day-weekday">${escapeHtml(weekday||'—')}</div>`;
          const shiftCount=group.items.length;
          const shiftWord=shiftCount===1?'смена':(shiftCount>=2&&shiftCount<=4?'смены':'смен');
          const headerMeta=document.createElement('div');
          headerMeta.className='shift-day-header-meta';
          headerMeta.innerHTML=`<span class="shift-day-meta-item">Смены: <strong>${escapeHtml(`${shiftCount} ${shiftWord}`)}</strong></span><span class="shift-day-meta-item">Выручка: <strong>${escapeHtml(formatMoney(subtotal.salesTotal))}</strong></span>`;
          header.appendChild(headerMain);
          header.appendChild(headerMeta);
          dayEl.appendChild(header);
          const body=document.createElement('div');
          body.className='shift-day-body';
          const dayPositions=makeCountsBucket();
          group.items.forEach(r=>{
            const card=document.createElement('article');
            card.className='shift-card';
            const dot=`<span class="dot" style="background:${escapeHtml(r.staff_color||staffColorByName(r.staff))};"></span>`;
            const devIcon=r.device_type==='Смартфон'?'📱':(r.device_type?'🖥️':'');
            const devChip=r.device_type?`<span class="chip">${devIcon} ${escapeHtml(r.device_type)}</span>`:'';
            const sales=r.sales||{};
            const preorders=r.preorders||{};
            const salary=r.salary||{};
            const positionsData=normalizePositions(r.positions);
            const getPositionCount=(key,fallbackObj,fallbackKeys)=>{
              if(positionsData){
                const val=positionsData[key];
                return{value:val,found:val!=null};
              }
              return extractCount(fallbackObj,fallbackKeys);
            };
            const phoneCount=getPositionCount('phones',sales,['phones','phone']);
            const accessoriesCount=getPositionCount('accessories',sales,['accessories','accessory']);
            const servicesCount=getPositionCount('services',sales,['services','service']);
            const preordersCount=getPositionCount('preorders',preorders,['count','preorders','total']);
            addCount(dayPositions,'phones',phoneCount);
            addCount(dayPositions,'accessories',accessoriesCount);
            addCount(dayPositions,'services',servicesCount);
            addCount(dayPositions,'preorders',preordersCount);
            addCount(positionsGrandTotals,'phones',phoneCount);
            addCount(positionsGrandTotals,'accessories',accessoriesCount);
            addCount(positionsGrandTotals,'services',servicesCount);
            addCount(positionsGrandTotals,'preorders',preordersCount);
            const positionsHtml=renderPositionsList({phones:phoneCount,accessories:accessoriesCount,services:servicesCount,preorders:preordersCount});
            const salesMetrics=[
              renderMetric('Телефоны',formatMoney(sales.phones),{money:true}),
              renderMetric('Аксессуары',formatMoney(sales.accessories),{money:true}),
              renderMetric('Услуги',formatMoney(sales.services),{money:true}),
              renderMetric('Выручка',formatMoney(sales.total),{money:true,accent:true})
            ].join('');
            const footerMetrics=[
              renderMetric('Предзаказы',formatMoney(preorders.total),{money:true}),
              renderMetric('ЗП',formatMoney(salary.total),{money:true})
            ].join('');
            card.innerHTML=`<div class="shift-card-header"><div class="shift-card-title"><div class="shift-card-store">${escapeHtml(r.store||'')}</div><div class="shift-card-staff">${dot}${escapeHtml(r.staff||'')} ${devChip}</div></div><div class="shift-card-time"><span class="shift-card-time-label">Выход</span><span class="shift-card-time-value">${escapeHtml(r.startTime||'—')}</span></div></div><div class="shift-card-body"><div class="shift-card-metrics">${salesMetrics}</div>${positionsHtml}</div><div class="shift-card-footer">${footerMetrics}</div>`;
            body.appendChild(card);
          });
          dayEl.appendChild(body);
          const dayMetrics=[
            renderMetric('Телефоны',formatMoney(subtotal.phones),{money:true}),
            renderMetric('Аксессуары',formatMoney(subtotal.accessories),{money:true}),
            renderMetric('Услуги',formatMoney(subtotal.services),{money:true}),
            renderMetric('Выручка',formatMoney(subtotal.salesTotal),{money:true,accent:true}),
            renderMetric('Предзаказы',formatMoney(subtotal.preorders),{money:true}),
            renderMetric('ЗП',formatMoney(subtotal.salary),{money:true})
          ].join('');
          const dayFooter=document.createElement('div');
          dayFooter.className='shift-day-footer';
          dayFooter.innerHTML=`<div class="shift-day-footer-title">Итого за день</div><div class="shift-day-footer-metrics">${dayMetrics}</div><div class="shift-day-footer-positions"><div class="shift-day-footer-title">Позиции</div>${renderPositionsList(dayPositions)}</div>`;
          dayEl.appendChild(dayFooter);
          fragment.appendChild(dayEl);
        });
      }
      $shiftDays.appendChild(fragment);
      const t=data?.totals||{};
      const readPositionValue=(obj,key)=>{
        if(!obj)return null;
        if(hasOwnProp(obj,key)){
          const val=obj[key];
          return val==null?null:toNumber(val);
        }
        const alt=key.endsWith('_count')?key:`${key}_count`;
        if(hasOwnProp(obj,alt)){
          const val=obj[alt];
          return val==null?null:toNumber(val);
        }
        return null;
      };
      const totalsPositionsBucket=makeCountsBucket();
      let totalsPositionsHasData=false;
      ['phones','accessories','services','preorders'].forEach(key=>{
        const val=readPositionValue(t.positions,key);
        if(val!=null){
          totalsPositionsBucket[key].value=val;
          totalsPositionsBucket[key].found=true;
          totalsPositionsHasData=true;
        }
      });
      const finalPositions=totalsPositionsHasData?totalsPositionsBucket:positionsGrandTotals;
      const pickValue=(value,fallback)=>value==null||value===''?fallback:value;
      const grandMetrics=[
        renderMetric('Телефоны',formatMoney(pickValue(t.sales_phones,aggregatedTotals.phones)),{money:true}),
        renderMetric('Аксессуары',formatMoney(pickValue(t.sales_accessories,aggregatedTotals.accessories)),{money:true}),
        renderMetric('Услуги',formatMoney(pickValue(t.sales_services,aggregatedTotals.services)),{money:true}),
        renderMetric('Выручка',formatMoney(pickValue(t.sales_total,aggregatedTotals.salesTotal)),{money:true,accent:true}),
        renderMetric('Предзаказы',formatMoney(pickValue(t.preorders_sum,aggregatedTotals.preorders)),{money:true}),
        renderMetric('ЗП',formatMoney(pickValue(t.salary_total,aggregatedTotals.salary)),{money:true})
      ].join('');
      $shiftGrandTotal.innerHTML=`<div class="shift-grand-total-title">Общий итог</div><div class="shift-grand-total-body">${grandMetrics}</div><div class="shift-grand-total-positions"><div class="shift-day-footer-title">Позиции</div>${renderPositionsList(finalPositions)}</div>`;
    }

    function getLedgerFilters(){return{dateFrom:$ledgerFrom.value||'',dateTo:$ledgerTo.value||'',store:$ledgerStore.value||'',staff:$ledgerStaff.value||''}}
    function loadShiftsLedger(){const params=getLedgerFilters();$btnLedgerUpdate.disabled=true;google.script.run.withSuccessHandler(data=>{$btnLedgerUpdate.disabled=false;renderShiftsTable(data||{rows:[],totals:{}})}).withFailureHandler(err=>{$btnLedgerUpdate.disabled=false;alert('Ошибка: '+(err?.message||err))}).getShiftsLedgerCached(params)}
    let shiftsInitDone=false;
    function initShiftsUIOnce(){
      if(shiftsInitDone)return;shiftsInitDone=true;
      fillSelectFromDict($shiftStore,NALICHIE.dicts?.stores,'Выбери магазин');fillSelectFromDict($shiftStaff,NALICHIE.dicts?.staff,'Выбери сотрудника');fillSelectFromDict($ledgerStore,NALICHIE.dicts?.stores,'Все магазины');fillSelectFromDict($ledgerStaff,NALICHIE.dicts?.staff,'Все сотрудники');
      google.script.run.withSuccessHandler(({nowDate,nowTime})=>{$shiftDateAuto.value=nowDate||'';const hhmm=String(nowTime||'').replace(/^(\d{2}):(\d{2}).*$/,'$1:$2');$shiftTimeAuto.value=hhmm}).withFailureHandler(()=>{}).getShiftsBootstrap();
      $btnShiftCheckIn.addEventListener('click',()=>{const store=$shiftStore.value.trim();const staff=$shiftStaff.value.trim();if(!store||!staff){alert('Выберите магазин и сотрудника');return}const device_type=getDeviceType();$btnShiftCheckIn.disabled=true;google.script.run.withSuccessHandler(res=>{$btnShiftCheckIn.disabled=false;if(res?.ok){$lastCheckLabel.textContent=`Отмечено: ${res.date_vyhoda} ${res.vremya_vyhoda} · ${res.store} — ${res.staff} (pre_day: ${res.pre_day||'—'})`;loadShiftsLedger()}else alert('Не удалось отметить смену')}).withFailureHandler(err=>{$btnShiftCheckIn.disabled=false;alert('Ошибка: '+(err?.message||err))}).createShiftCheckIn({store,staff,device_type})});
      $btnLedgerUpdate.addEventListener('click',loadShiftsLedger);
      const debounced=debounce(loadShiftsLedger,250);[$ledgerFrom,$ledgerTo,$ledgerStore,$ledgerStaff].forEach(el=>{el&&el.addEventListener(el.tagName==='INPUT'?'input':'change',debounced)});
      loadShiftsLedger()
    }

    /* ===== Делегированные обработчики статусов ===== */
    if(!$preTbody._delegated){$preTbody.addEventListener('change',e=>{const sel=e.target.closest('select[data-role="pre-status"]');if(!sel)return;const row=PRE_ROWS_BY_ID.get(sel.dataset.rowId);if(!row)return;const newSt=sel.value;if(!newSt)return;
      if(newSt==='Завершен'||newSt==='Завершён'){openPreFinish(row,()=>{sel.value=row.preorder_statuses||''})}
      else{google.script.run.withSuccessHandler(()=>loadPreorders()).withFailureHandler(err=>{alert('Ошибка: '+(err?.message||err));sel.value=row.preorder_statuses||''}).updatePreorderStatus({id:row.id,preorder_statuses:newSt})}
    });$preTbody._delegated=true}
    if(!$diagTbody._delegated){$diagTbody.addEventListener('change',e=>{const sel=e.target.closest('select[data-role="diag-status"]');if(!sel)return;const row=DIAG_ROWS_BY_ID.get(sel.dataset.rowId);if(!row)return;const newSt=sel.value||'';const current=row.diagnostic_statuses||'';if(!newSt){sel.value=current;return}const currentLower=String(current).toLowerCase();if(currentLower==='выдан'&&newSt!==current){sel.value=current;alert('Статус "Выдан" изменить нельзя');return}if(newSt===current){sel.value=current;return}if(newSt==='Выдан'){sel.value=current;openDiagIssue(row,sel);return}sel.disabled=true;google.script.run.withSuccessHandler(()=>{sel.disabled=false;loadDiagnostics()}).withFailureHandler(err=>{sel.disabled=false;alert('Ошибка: '+(err?.message||err));sel.value=current}).updateDiagnosticStatus({id:row.id,diagnostic_statuses:newSt})});$diagTbody.addEventListener('click',e=>{const btn=e.target.closest('button[data-role="diag-pay"]');if(!btn)return;const row=DIAG_ROWS_BY_ID.get(btn.dataset.rowId);if(!row)return;openDiagPayments(row)});$diagTbody._delegated=true}
  </script>

  <?!= HtmlService.createHtmlOutputFromFile('DailyReport.client').getContent(); ?>
</body>
</html>